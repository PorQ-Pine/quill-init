import { ProgressBar } from "../../ui-common/progressbar.slint";
import { Button } from "../../ui-common/button.slint";
import { IconButton } from "../../ui-common/iconbutton.slint";
import { Switch } from "../../ui-common/switch.slint";
import { ScrollView, TabWidget, TextEdit } from "std-widgets.slint";
import { MovingDots } from "../../ui-common/moving-dots.slint";
import { HLine } from "../../ui-common/hline.slint";
import { VLine } from "../../ui-common/vline.slint";
import { Dialog } from "../../ui-common/dialog.slint";
import { SectionButton } from "../../ui-common/sectionbutton.slint";
import { LineEdit } from "../../ui-common/lineedit.slint";
import { Slider } from "../../ui-common/slider.slint";
import {
    VirtualKeyboard,
    VirtualKeyboardHandler,
    KeyModel,
} from "../../ui-common/virtual_keyboard/virtual_keyboard.slint";
import { HList } from "../../ui-common/hlist.slint";

export enum Page { None, QuillBoot, VersionInfo, BootSplash, Options, BootConfiguration, RecoveryOptions, StorageEncryptionOptions, UserLogin, InvalidBootConfig, Error, ShutDownSplash }
export enum QrCodePage { QrCode, NotAvailable }
export enum ProgressWidget { ProgressBar, MovingDots }
export enum DialogType { None, Toast, SoftReset, WifiUI, WifiPassphrase, EncryptionConfirmPassword, EncryptionChangePassword, EncryptionNewPassword, Brightness, BatteryStatus, PowerOptions }
export enum RootFsShutDownCommand { None, PowerOff, Reboot }
export { VirtualKeyboardHandler, KeyModel }

export struct SystemUser {
    name: string,
    encryption: bool,
    encrypted_key: string,
    salt: string,
}

export component AppWindow inherits Window {
    // Scaling
    in-out property <int> scaling_factor: 1;
    // Root properties
    default-font-family: "U001";
    default-font-size: 40px * scaling_factor;
    page: Page.None;
    // Callbacks
    callback power_off();
    callback direct_power_off();
    callback reboot();
    callback direct_reboot();
    callback toggle_ui_scale();
    callback toggle_persistent_rootfs();
    callback toggle_wifi();
    callback boot_default();
    callback soft_reset();
    callback get_networks();
    callback connect_to_wifi_network(string, string);
    callback get_users_using_storage_encryption();
    callback get_selected_encryption_user_details(string);
    callback change_user_password(string, string, string, bool);
    callback disable_storage_encryption(string, string);
    callback set_brightness_sliders_levels;
    callback change_cool_brightness(int);
    callback change_warm_brightness(int);
    callback login(string, string);
    callback change_initial_screen_rotation(int);
    callback change_splash_wallpaper_model(string);
    callback generate_splash_wallpaper(bool);
    callback refresh_screen(bool);
    // In-out properties
    in-out property <string> version_string;
    in-out property <string> short_version_string;
    in-out property <float> boot_progress;
    in-out property <Page> page;
    in-out property <QrCodePage> qr_code_page;
    in-out property <ProgressWidget> progress_widget;
    in-out property <DialogType> dialog;
    in-out property <string> dialog_message;
    in-out property <int> dialog_millis_count;
    in-out property <float> button_scaling_multiplier: 1;
    in-out property <bool> startup_finished: false;
    in-out property <string> error_reason;
    in-out property <string> program_output;
    in-out property <string> kernel_buffer;
    in-out property <image> debug_qr_code;
    in-out property <image> help_uri_qr_code;
    in-out property <image> splash_wallpaper;
    in-out property <int> debug_tab_index: 0;
    in-out property <string> section_header_title;
    in-out property <image> wifi_icon: @image-url("../../icons/wifi-init.svg");
    in-out property <image> battery_icon;
    in-out property <bool> sticky_toast: false;
    property <[string]> orientations_list: ["0", "90", "180", "270"];
    in property <[string]> splash_wallpaper_models_list;
    in-out property <int> orientations_list_index: 3;
    in-out property <int> splash_wallpaper_models_list_index;
    // Configuration properties
    in-out property <bool> persistent_rootfs;
    in property <bool> recovery_features;
    // Run-time properties
    in property <bool> wifi_enabled;
    in property <bool> wifi_connected;
    in property <bool> wifi_scanning_lock;
    in property <bool> wifi_connecting_lock;
    in property <bool> wifi_enabling_lock;
    in property <bool> wifi_disabling_lock;
    in property <string> wifi_connected_name;
    in property <string> wifi_ip_address;
    in-out property <string> potential_wifi_network;
    in property <[string]> wifi_network_names;
    in property <[bool]> wifi_network_open_vec;
    in property <[string]> users_using_storage_encryption;
    in-out property <SystemUser> selected_encryption_user;
    in property <string> current_time;
    in property <int> cool_brightness;
    in property <int> warm_brightness;
    in property <int> battery_level;
    in property <bool> charger_plugged_in;
    in property <string> default_user: "";
    in property <bool> login_captive_portal: false;
    in property <bool> quill_recovery;
    out property <RootFsShutDownCommand> shutdown_command: RootFsShutDownCommand.None;
    in property <string> splash_wallpaper_text;
    in property <string> splash_wallpaper_date_time_information;
    // Generic multipliers for default-sized and smaller-sized items
    property <float> wmultiplier: 0.25;
    property <float> hmultiplier: 0.05;
    property <float> swmultiplier: 0.25;
    property <float> shmultiplier: 0.03;
    property <float> dialog_sizes_multiplier: 0.9;
    // Default sizes/radii/properties; there may be elements that don't enforce them for various reasons
    property <relative-font-size> header_font_size: 2rem;
    property <length> layout_padding: 30px;
    property <length> layout_spacing: 10px;
    property <length> button_width: root.width * wmultiplier * scaling_factor * button_scaling_multiplier;
    property <length> button_height: root.height * hmultiplier * scaling_factor * button_scaling_multiplier;
    property <length> icon_button_height: button_height * 0.5;
    property <length> bar_button_height: button_height * 0.7;
    property <length> slider_height: 15px * scaling_factor;
    property <length> section_button_height: button_height * 1.25;
    property <length> switch_width: button_width * 0.45;
    property <length> switch_height: button_height * 0.7;
    property <length> radius: 10px;
    property <length> logo_width: 0.45 * root.width;
    property <length> logo_height: logo_width;
    property <length> medium_logo_width: logo_width * 0.55;
    property <length> medium_logo_height: medium_logo_width;
    property <string> header_font_family: "Inter";
    property <string> console_font_family: "Roboto Mono";
    property <string> regular_font_family: root.default-font-family;
    property <length> console_header_font_size: 0.8 * self.default_font_size;
    property <length> console_body_font_size: 0.6 * self.default_font_size;
    property <length> tab_rectangle_border_width: 2px;
    property <color> tab_rectangle_border_color: darkgrey;
    property <length> dialog_rectangle_thickness: 6px;
    property <length> keyboard_key_height: 0.055 * root.height;
    property <length> approx_keyboard_height: keyboard_key_height * 4.15;
    property <length> approx_bar_height: layout_padding + bar_button_height + layout_spacing + 0.5 * 5px + 3px + layout_spacing + 0.5 * 5px;
    property <length> bar_icon_button_padding: 7.5px;
    property <length> space_between_keyboard_and_widget: 100px;
    property <color> item_border_color: #a5a5a5;
    property <color> item_selected_color: #dbdada;
    property <string> version_info_header: "About";

    function prepare_splash_wallpaper() {
        generate_splash_wallpaper(false);
        page = Page.ShutDownSplash;
    }

    if (page == Page.ShutDownSplash): VerticalLayout {
        Image {
            source: splash_wallpaper;
            width: root.width;
            height: root.height;
        }
    }

    if(page == Page.ShutDownSplash): VerticalLayout {
        alignment: center;
        HorizontalLayout {
            alignment: center;
            Rectangle {
                border-radius: radius * 2.5;
                border-color: black;
                background: white;
                border-width: 10px;
                width: scaling_factor * root.width * 0.5;
                height: scaling_factor * root.height * 0.145;
                HorizontalLayout {
                    Rectangle {
                        width: (layout_spacing * 2.5 + parent.width * 0.025) * 0.725;
                    }

                    Image {
                        source: @image-url("../../../branding/quillos.svg");
                        width: root.width * 0.15;
                        height: self.width;
                        y: (parent.height - self.height) / 2;
                    }

                    Rectangle {
                        width: parent.width * 0.025;
                    }

                    VerticalLayout {
                        alignment: center;
                        Text {
                            text: splash_wallpaper_text;
                            font-family: header_font_family;
                            font-size: header_font_size * 0.55;
                            font-weight: 800;
                            vertical-alignment: center;
                            horizontal-alignment: center;
                        }

                        HLine {
                            top-padding-multiplier: 4.5;
                            bottom-padding-multiplier: self.top-padding-multiplier;
                        }

                        HorizontalLayout {
                            alignment: center;
                            Image {
                                source: @image-url("../../icons/clock.svg");
                                height: root.height * scaling_factor * 0.025;
                                width: self.height;
                                y: (parent.height - self.height) / 2;
                            }

                            Rectangle {
                                width: layout_spacing * 0.8;
                            }

                            Text {
                                text: splash_wallpaper_date_time_information;
                                font-size: header_font_size * 0.46;
                                vertical-alignment: center;
                            }

                            Rectangle {
                                width: scaling_factor * 37.5px + layout_spacing * 0.8;
                            }

                            Image {
                                source: battery_icon;
                                height: root.height * scaling_factor * 0.03;
                                width: self.height;
                                y: (parent.height - self.height) / 2;
                            }

                            Rectangle {
                                width: layout_spacing * 1.3;
                            }

                            Text {
                                text: "\{battery_level} %";
                                font-size: header_font_size * 0.46;
                                vertical-alignment: center;
                            }
                        }
                    }

                    Rectangle {
                        width: parent.width * 0.065;
                    }
                }
            }
        }
    }

    // Main UI
    // Don't ask me why a ScrollView is needed here to prevent binding loops...
    ScrollView {
        VerticalLayout {
            padding: layout_padding;
            spacing: layout_spacing;
            if (page != Page.QuillBoot) && (page != Page.BootSplash) && (page != Page.ShutDownSplash) && (page != Page.UserLogin) && (page != Page.None) && (page != Page.InvalidBootConfig) && (page != Page.Error): HorizontalLayout {
                IconButton {
                    icon: @image-url("../../icons/arrow-back.svg");
                    border-radius: radius;
                    height: icon_button_height;
                    width: self.height;
                    /* This is needed to center this item vertically on the horizontal layout.
                        It would be great if Slint provided an option to do it automatically instead... */
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        if login_captive_portal {
                            root.page = Page.UserLogin;
                        } else if root.page == Page.Options || root.page == Page.VersionInfo {
                            root.page = Page.QuillBoot;
                        } else if root.page == Page.RecoveryOptions || root.page == Page.BootConfiguration || root.page == Page.StorageEncryptionOptions {
                            section_header_title = "Options";
                            root.page = Page.Options;
                        }
                    }
                }

                Rectangle { }

                Text {
                    text: section_header_title;
                    horizontal-alignment: center;
                    font-family: header_font_family;
                    font-weight: 800;
                    y: (parent.height - self.height) / 2;
                }

                Rectangle { }

                Rectangle {
                    height: icon_button_height;
                    width: self.height;
                }
            }
            if (page == Page.QuillBoot || page == Page.UserLogin): HorizontalLayout {
                spacing: layout_spacing * 1.5;
                Text {
                    text: current_time;
                    vertical-alignment: center;
                    font-family: header_font_family;
                    font-weight: 800;
                }

                Rectangle { }

                if (page != Page.UserLogin): IconButton {
                    icon: wifi_icon;
                    border-radius: radius;
                    height: bar_button_height;
                    width: self.height;
                    padding-value: bar_icon_button_padding;
                    background-color: dialog == DialogType.WifiUI ? #000000 : #ffffff;
                    y: (parent.height - self.height) / 2;
                    enabled: wifi_icon == @image-url("../../icons/wifi-init.svg") ? false : true;
                    clicked => {
                        dialog = DialogType.WifiUI;
                    }
                }

                if (page != Page.UserLogin): VLine {
                    thickness: 1px;
                    left-padding-multiplier: 0.05;
                    right-padding-multiplier: self.left-padding-multiplier;
                }

                IconButton {
                    icon: @image-url("../../icons/brightness.svg");
                    border-radius: radius;
                    height: bar_button_height;
                    width: self.height;
                    padding-value: bar_icon_button_padding;
                    background-color: dialog == DialogType.Brightness ? #000000 : #ffffff;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        set_brightness_sliders_levels();
                        dialog = DialogType.Brightness;
                    }
                }

                VLine {
                    thickness: 1px;
                    left-padding-multiplier: 0.05;
                    right-padding-multiplier: self.left-padding-multiplier;
                }

                IconButton {
                    icon: battery_icon;
                    border-radius: radius;
                    height: bar_button_height;
                    width: self.height;
                    padding-value: bar_icon_button_padding * 0.4;
                    background-color: dialog == DialogType.BatteryStatus ? #000000 : #ffffff;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        dialog = DialogType.BatteryStatus;
                    }
                }

                VLine {
                    thickness: 1px;
                    left-padding-multiplier: 0.05;
                    right-padding-multiplier: self.left-padding-multiplier;
                }

                IconButton {
                    icon: @image-url("../../icons/power.svg");
                    border-radius: radius;
                    height: bar_button_height;
                    width: self.height;
                    padding-value: bar_icon_button_padding;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        dialog = DialogType.PowerOptions;
                    }
                }
            }
            if (page != Page.BootSplash) && (page != Page.ShutDownSplash) && (page != Page.None) && (page != Page.InvalidBootConfig) && (page != Page.Error): HLine {
                top-padding-multiplier: page == Page.QuillBoot ? 0.5 : 1;
            }

            if (page == Page.QuillBoot): VerticalLayout {
                padding: layout_padding;
                Rectangle { }

                HorizontalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../../branding/quillos.svg");
                        width: root.width * 0.35;
                        height: self.width;
                    }
                }

                Rectangle { }

                HorizontalLayout {
                    Text {
                        text: "QuillBoot";
                        horizontal-alignment: center;
                        font-family: header_font_family;
                        font-size: header_font_size;
                        font-weight: 800;
                    }
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: recovery_features ? "Diagnostics & Recovery" : "Diagnostics";
                        font-size: 1rem;
                    }
                }

                Rectangle { }

                HorizontalLayout {
                    alignment: center;
                    spacing: layout_spacing * 4;
                    Button {
                        text: "Options";
                        width: button_width;
                        height: button_height;
                        border-radius: radius;
                        font-family: header_font_family;
                        clicked => {
                            section_header_title = "Options";
                            root.page = Page.Options;
                        }
                    }

                    Button {
                        text: "Quill OS";
                        width: button_width;
                        height: button_height;
                        border-radius: radius;
                        font-family: header_font_family;
                        clicked => {
                            root.boot_default();
                        }
                    }
                }

                Rectangle { }

                HorizontalLayout {
                    VerticalLayout {
                        alignment: center;
                        IconButton {
                            icon: @image-url("../../icons/info.svg");
                            height: switch_height;
                            width: self.height;
                            border-radius: radius;
                            clicked => {
                                section_header_title = version_info_header;
                                root.page = Page.VersionInfo;
                            }
                        }
                    }

                    Rectangle { }

                    Text {
                        vertical-alignment: center;
                        font-family: regular_font_family;
                        text: "Scale GUI";
                    }

                    Rectangle {
                        horizontal-stretch: 0.05;
                    }

                    Switch {
                        y: (parent.height - self.height) / 2;
                        width: switch_width;
                        height: switch_height;
                        border-radius: radius;
                        activated: scaling_factor > 1 ? true : false;
                        toggled => {
                            root.toggle_ui_scale();
                        }
                    }
                }
            }

            if (page == Page.BootSplash): VerticalLayout {
                padding-top: 550px;
                padding-bottom: self.padding-top;
                HorizontalLayout {
                    alignment: center;
                    Image {
                        width: logo_width;
                        height: logo_height;
                        source: @image-url("../../../branding/quillos.svg");
                    }
                }

                Rectangle { }

                HorizontalLayout {
                    alignment: center;
                    if (progress_widget == ProgressWidget.ProgressBar): ProgressBar {
                        progress: root.boot_progress;
                        width: 37.5%;
                        height: 2%;
                    }
                    if (progress_widget == ProgressWidget.MovingDots): Rectangle {
                        width: 14%;
                        MovingDots {
                            ready: startup_finished;
                        }
                    }
                }
            }

            if (page == Page.VersionInfo): VerticalLayout {
                spacing: layout_spacing;
                Rectangle { }

                HorizontalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../../branding/quillos.svg");
                        width: root.width * 0.25;
                        height: self.width;
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                ScrollView {
                    height: 50%;
                    mouse-drag-pan-enabled: true;
                    VerticalLayout {
                        Text {
                            text: "Quill OS";
                            horizontal-alignment: center;
                            font-family: header_font_family;
                            font-size: header_font_size;
                            font-weight: 800;
                        }

                        Rectangle {
                            vertical-stretch: 0.1;
                        }

                        Text {
                            text: "Copyright © 2021-2025";
                            horizontal-alignment: center;
                            font-family: header_font_family;
                            font-weight: 800;
                        }

                        Text {
                            text: "Nicolas Mailloux\n<nicolecrivain@gmail.com>\nSzybet\n<https://github.com/Szybet>";
                            font-family: regular_font_family;
                            font-size: root.default-font-size * 0.9;
                            horizontal-alignment: center;
                        }

                        Rectangle {
                            vertical-stretch: 0.25;
                        }

                        Text {
                            text: "Software information";
                            horizontal-alignment: center;
                            font-family: header_font_family;
                            font-weight: 800;
                        }

                        Text {
                            text: root.version_string;
                            font-size: root.default-font-size * 0.9;
                            horizontal-alignment: center;
                            wrap: word-wrap;
                        }
                    }
                }

                Rectangle { }
            }

            if (page == Page.Options): ScrollView {
                mouse-drag-pan-enabled: true;
                VerticalLayout {
                    spacing: layout_spacing;
                    if (recovery_features): SectionButton {
                        text: "Recovery options";
                        height: section_button_height;
                        border-radius: radius;
                        font-family: header_font_family;
                        scaling-factor: scaling_factor;
                        icon: @image-url("../../icons/recovery.svg");
                        clicked => {
                            section_header_title = self.text;
                            page = Page.RecoveryOptions;
                        }
                    }

                    SectionButton {
                        text: "Users & storage encryption";
                        height: section_button_height;
                        border-radius: radius;
                        font-family: header_font_family;
                        scaling-factor: scaling_factor;
                        icon: @image-url("../../icons/key.svg");
                        clicked => {
                            get_users_using_storage_encryption();
                            section_header_title = self.text;
                            selected_encryption_user.name = "";
                            page = Page.StorageEncryptionOptions;
                        }
                    }

                    SectionButton {
                        text: "System & boot configuration";
                        height: section_button_height;
                        border-radius: radius;
                        font-family: header_font_family;
                        scaling-factor: scaling_factor;
                        icon: @image-url("../../icons/settings.svg");
                        clicked => {
                            section_header_title = self.text;
                            page = Page.BootConfiguration;
                        }
                    }
                }

                Rectangle { }
            }

            if (page == Page.RecoveryOptions): VerticalLayout {
                ScrollView {
                    mouse-drag-pan-enabled: true;
                    VerticalLayout {
                        spacing: layout_spacing;
                        padding-top: layout_spacing;
                        padding-bottom: layout_spacing;
                        HorizontalLayout {
                            spacing: layout_spacing;
                            padding-left: layout_padding;
                            padding-right: layout_padding;
                            Rectangle {
                                Text {
                                    text: "Soft-reset this device";
                                    font-family: regular_font_family;
                                    vertical-alignment: center;
                                }
                            }

                            Rectangle { }

                            Button {
                                text: "Soft reset";
                                width: button_width;
                                height: button_height;
                                border-radius: radius;
                                font-family: header_font_family;
                                clicked => {
                                    dialog_message = "This will erase all of the user data on this device and reset settings to default, without reinstalling the firmware. Are you sure you want to continue?";
                                    dialog = DialogType.SoftReset;
                                }
                            }
                        }
                    }

                    Rectangle { }
                }
            }

            if (page == Page.BootConfiguration): VerticalLayout {
                ScrollView {
                    mouse-drag-pan-enabled: true;
                    VerticalLayout {
                        spacing: layout_spacing;
                        padding-top: layout_spacing;
                        padding-bottom: self.padding-top;
                        HorizontalLayout {
                            padding-left: layout_padding;
                            padding-right: self.padding-left;
                            Rectangle {
                                Text {
                                    text: "Persistent root filesystem";
                                    font-family: regular_font_family;
                                    vertical-alignment: center;
                                }
                            }

                            Rectangle { }

                            Switch {
                                width: switch_width;
                                height: switch_height;
                                y: (parent.height - self.height) / 2;
                                border-radius: radius;
                                activated: persistent_rootfs;
                                toggled => {
                                    persistent_rootfs = !persistent_rootfs;
                                    toggle_persistent_rootfs();
                                }
                            }
                        }

                        HorizontalLayout {
                            padding-left: layout_padding;
                            padding-right: self.padding-left;
                            spacing: layout_spacing;
                            Rectangle {
                                Text {
                                    text: "Initial screen rotation (degrees)";
                                    font-family: regular_font_family;
                                    vertical-alignment: center;
                                }
                            }

                            Rectangle { }

                            HList {
                                border-radius: radius;
                                element-width: switch_width;
                                button-width: switch_width * 0.5 - layout_spacing * 1.35 - 2px;
                                spacing: layout_spacing;
                                height: switch_height;
                                list: orientations_list;
                                index: orientations_list_index;
                                index_changed(i) => {
                                    change_initial_screen_rotation(i);
                                }
                            }
                        }

                        HorizontalLayout {
                            padding-left: layout_padding;
                            padding-right: self.padding-left;
                            spacing: layout_spacing;
                            Rectangle {
                                Text {
                                    text: "Splash wallpaper model";
                                    font-family: regular_font_family;
                                    vertical-alignment: center;
                                }
                            }

                            Rectangle { }

                            HList {
                                border-radius: radius;
                                element-width: switch_width * 2.5;
                                button-width: switch_width * 0.5 - layout_spacing * 1.35 - 2px;
                                spacing: layout_spacing;
                                height: switch_height;
                                list: splash_wallpaper_models_list;
                                index: splash_wallpaper_models_list_index;
                                index_changed(i) => {
                                    change_splash_wallpaper_model(self.current-text);
                                }
                            }
                        }

                        Rectangle { }
                    }
                }
            }

            if (page == Page.StorageEncryptionOptions): VerticalLayout {
                HorizontalLayout {
                    spacing: layout_spacing;
                    if (users_using_storage_encryption.length > 0): ScrollView {
                        mouse-drag-pan-enabled: true;
                        width: 35%;
                        VerticalLayout {
                            spacing: layout_spacing;
                            for username[index] in users_using_storage_encryption: i-user-using-encryption-button := TouchArea {
                                i-user-using-encryption-container := Rectangle {
                                    border-color: item_border_color;
                                    border-radius: radius;
                                    border-width: 3px;
                                    background: username == selected_encryption_user.name ? item_selected_color : #ffffff;
                                    HorizontalLayout {
                                        padding: 20px;
                                        spacing: layout_spacing * 1.5;
                                        VerticalLayout {
                                            alignment: center;
                                            Image {
                                                source: @image-url("../../icons/user.svg");
                                                height: icon_button_height * 1.15;
                                                width: self.height;
                                                colorize: i-user-using-encryption-button.pressed ? #ffffff : #000000;
                                            }
                                        }

                                        i-user-using-encryption-text := Text {
                                            font-family: regular_font_family;
                                            font-size: root.default-font-size * dialog_sizes_multiplier;
                                            vertical-alignment: center;
                                            wrap: word-wrap;
                                            text: username;
                                        }

                                        VerticalLayout {
                                            alignment: center;
                                            Image {
                                                source: @image-url("../../icons/key.svg");
                                                height: icon_button_height * 1.15;
                                                width: self.height;
                                                colorize: i-user-using-encryption-button.pressed ? #ffffff : #000000;
                                            }
                                        }
                                    }
                                }

                                states [
                                    pressed when self.pressed: {
                                        i-user-using-encryption-container.background: #000000;
                                        i-user-using-encryption-text.color: #ffffff;
                                    }
                                ]

                                clicked => {
                                    get_selected_encryption_user_details(username);
                                }
                            }
                            Rectangle { }
                        }
                    }

                    if (users_using_storage_encryption.length > 0): VLine {
                        thickness: 2px;
                    }

                    if (selected_encryption_user.name.is-empty): VerticalLayout {
                        alignment: center;
                        Text {
                            text: users_using_storage_encryption.length == 0 ? "No users using storage encryption found" : "Select a user to manage its settings";
                            horizontal-alignment: center;
                            font-family: regular_font_family;
                            wrap: word-wrap;
                        }
                    }
                    if (!selected_encryption_user.name.is-empty): ScrollView {
                        mouse-drag-pan-enabled: true;
                        VerticalLayout {
                            spacing: layout_spacing / dialog_sizes_multiplier;
                            padding-top: self.spacing;
                            padding-bottom: self.spacing;
                            HorizontalLayout {
                                padding-left: layout_padding * dialog_sizes_multiplier;
                                padding-right: self.padding-left;
                                Text {
                                    text: "Encryption";
                                    vertical-alignment: center;
                                }

                                Switch {
                                    y: (parent.height - self.height) / 2;
                                    width: switch_width * dialog_sizes_multiplier;
                                    height: switch_height * dialog_sizes_multiplier;
                                    border-radius: radius;
                                    activated: selected_encryption_user.encryption;
                                    special-activation: true;
                                    toggled => {
                                        TextInputInterface.text-input-focused = true;
                                        if selected_encryption_user.encryption {
                                            dialog = DialogType.EncryptionConfirmPassword;
                                        } else {
                                            dialog = DialogType.EncryptionNewPassword;
                                        }
                                    }
                                }
                            }

                            if (selected_encryption_user.encryption): HLine {
                                thickness: 1px;
                            }

                            if (selected_encryption_user.encryption): HorizontalLayout {
                                padding-left: layout_padding * dialog_sizes_multiplier;
                                padding-right: self.padding-left;
                                Text {
                                    text: "Password";
                                    vertical-alignment: center;
                                }

                                Button {
                                    width: button_width * dialog_sizes_multiplier;
                                    height: button_height * dialog_sizes_multiplier;
                                    font-family: header_font_family;
                                    font-size: root.default-font-size * dialog_sizes_multiplier;
                                    border-radius: radius;
                                    text: "Change";
                                    clicked => {
                                        TextInputInterface.text-input-focused = true;
                                        dialog = DialogType.EncryptionChangePassword;
                                    }
                                }
                            }

                            if (selected_encryption_user.encryption): HLine {
                                thickness: 1px;
                            }

                            if (selected_encryption_user.encryption): HorizontalLayout {
                                padding-left: layout_padding * dialog_sizes_multiplier;
                                padding-right: self.padding-left;
                                Text {
                                    text: "Key";
                                    vertical-alignment: center;
                                }

                                Rectangle {
                                    width: 50px;
                                }

                                Text {
                                    text: selected_encryption_user.encrypted-key;
                                    font-family: console_font_family;
                                    font-size: console_body_font_size;
                                    wrap: char-wrap;
                                    vertical-alignment: center;
                                    horizontal-alignment: right;
                                }
                            }

                            if (selected_encryption_user.encryption): HLine {
                                thickness: 1px;
                            }

                            if (selected_encryption_user.encryption): HorizontalLayout {
                                padding-left: layout_padding * dialog_sizes_multiplier;
                                padding-right: self.padding-left;
                                Text {
                                    text: "Salt";
                                    vertical-alignment: center;
                                }

                                Rectangle {
                                    width: 50px;
                                }

                                Text {
                                    text: selected_encryption_user.salt;
                                    font-family: console_font_family;
                                    font-size: console_body_font_size;
                                    wrap: char-wrap;
                                    vertical-alignment: center;
                                    horizontal-alignment: right;
                                }
                            }

                            HLine {
                                thickness: 1px;
                            }

                            HorizontalLayout {
                                padding-left: layout_padding * dialog_sizes_multiplier;
                                padding-right: self.padding-left;
                                Text {
                                    text: "Default user";
                                    vertical-alignment: center;
                                }

                                Rectangle {
                                    width: 50px;
                                }

                                Text {
                                    text: default_user == selected_encryption_user.name ? "Yes" : "No";
                                    font-family: console_font_family;
                                    font-size: console_body_font_size;
                                    wrap: char-wrap;
                                    vertical-alignment: center;
                                    horizontal-alignment: right;
                                }
                            }

                            Rectangle { }
                        }
                    }
                }
            }

            if (page == Page.UserLogin): VerticalLayout {
                alignment: center;
                HorizontalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../../branding/quillos.svg");
                        width: root.width * 0.3;
                        height: self.width;
                    }
                }

                Rectangle {
                    height: root.height * 0.05;
                }

                HorizontalLayout {
                    alignment: center;
                    IconButton {
                        icon: @image-url("../../icons/info.svg");
                        border-radius: radius;
                        height: button_height;
                        width: self.height;
                        y: (parent.height - self.height) / 2;
                        padding-value: bar_icon_button_padding * 0.2;
                        clicked => {
                            TextInputInterface.text-input-focused = false;
                            section_header_title = version_info_header;
                            page = Page.VersionInfo;
                        }
                    }

                    Rectangle {
                        width: root.width * 0.0425;
                    }

                    VerticalLayout {
                        spacing: layout_spacing * 2.5;
                        HorizontalLayout {
                            alignment: center;
                            login-user-edit := LineEdit {
                                default-height: root.height * 0.035;
                                width: scaling_factor > 1 ? root.width * 0.6 : root.width * 0.35;
                                scaling-factor: scaling_factor;
                                border-radius: radius;
                                placeholder-text: "Username";
                                text: default_user;
                                font-size: root.default-font-size * dialog_sizes_multiplier;
                                input-type: text;
                            }
                        }

                        HorizontalLayout {
                            alignment: center;
                            login-password-edit := LineEdit {
                                default-height: root.height * 0.035;
                                width: scaling_factor > 1 ? root.width * 0.6 : root.width * 0.35;
                                scaling-factor: scaling_factor;
                                border-radius: radius;
                                placeholder-text: "Password";
                                font-size: root.default-font-size * dialog_sizes_multiplier;
                                input-type: password;
                            }
                        }
                    }

                    Rectangle {
                        width: root.width * 0.035;
                    }

                    IconButton {
                        icon: @image-url("../../icons/login.svg");
                        border-radius: radius;
                        height: button_height;
                        width: self.height;
                        y: (parent.height - self.height) / 2;
                        padding-value: bar_icon_button_padding * 0.2;
                        enabled: !login-user-edit.text.is-empty;
                        clicked => {
                            TextInputInterface.text-input-focused = false;
                            login(login-user-edit.text, login-password-edit.text);
                        }
                    }
                }

                Rectangle {
                    height: root.height * 0.02;
                }

                HorizontalLayout {
                    alignment: center;
                    HorizontalLayout {
                        width: scaling_factor > 1 ? root.width * 0.6 : root.width * 0.35;
                        Text {
                            font-family: regular_font_family;
                            text: "Scale GUI";
                            font-size: root.default-font-size * dialog_sizes_multiplier;
                            vertical-alignment: center;
                        }

                        Rectangle { }

                        Switch {
                            y: (parent.height - self.height) / 2;
                            width: switch_width * dialog_sizes_multiplier;
                            height: switch_height * dialog_sizes_multiplier;
                            border-radius: radius;
                            activated: scaling_factor > 1 ? true : false;
                            toggled => {
                                root.toggle_ui_scale();
                            }
                        }
                    }
                }

                if (TextInputInterface.text-input-focused): Rectangle {
                    height: root.height * 0.25;
                }
            }

            if (page == Page.InvalidBootConfig): VerticalLayout {
                alignment: center;
                spacing: layout_spacing;
                HorizontalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../icons/warning.svg");
                        width: logo_width * 0.9;
                        height: self.width;
                    }
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: "Warning";
                        horizontal-alignment: center;
                        font-family: header_font_family;
                        font-size: header_font_size;
                        font-weight: 800;
                    }
                }

                Rectangle {
                    height: root.height * 0.025;
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: "The boot configuration which was found on this device is invalid: it might possibly have been corrupted. A new, working one has been written for reference alongside the current one.\n\nPress 'Continue' to overwrite the current configuration (leaving a backup in place) and replace it with the default one.\n\nPress 'Power off' to edit the configuration manually on your computer and retry the boot process again.";
                        width: root.width * 0.55;
                        wrap: word-wrap;
                        horizontal-alignment: center;
                    }
                }

                Rectangle {
                    height: root.height * 0.05;
                }

                HorizontalLayout {
                    alignment: center;
                    spacing: layout_spacing * 4;
                    Button {
                        text: "Power off";
                        width: button_width;
                        height: button_height;
                        border-radius: radius;
                        font-family: header_font_family;
                        clicked => {
                            prepare_splash_wallpaper();
                            direct_power_off();
                        }
                    }

                    Button {
                        text: "Continue";
                        width: button_width;
                        height: button_height;
                        border-radius: radius;
                        font-family: header_font_family;
                        clicked => {
                            if quill_recovery {
                                root.page = Page.QuillBoot;
                            } else {
                                boot_default();
                            }
                        }
                    }
                }
            }

            if (page == Page.Error): VerticalLayout {
                padding-left: layout_padding;
                padding-right: layout_padding;
                Rectangle {
                    vertical-stretch: 0.1;
                }

                HorizontalLayout {
                    alignment: center;
                    spacing: root.width * 0.04;
                    Image {
                        source: @image-url("../../icons/x-alert.svg");
                        width: medium_logo_width;
                        height: medium_logo_height;
                    }

                    Image {
                        source: help_uri_qr_code;
                        width: medium_logo_width;
                        height: medium_logo_height;
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                Text {
                    text: "Fatal error";
                    horizontal-alignment: center;
                    font-family: header_font_family;
                    font-size: header_font_size;
                    font-weight: 800;
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: error_reason;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                        font-family: console_font_family;
                        font-size: console_header_font_size;
                        width: root.width * 0.7;
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                TabWidget {
                    current-index: debug_tab_index;
                    Tab {
                        title: "Debug QR code";
                        Rectangle {
                            border-width: tab_rectangle_border_width;
                            border-color: tab_rectangle_border_color;
                            VerticalLayout {
                                alignment: center;
                                if (qr_code_page == QrCodePage.QrCode): Image {
                                    source: debug_qr_code;
                                    height: 99%;
                                }
                                if (qr_code_page == QrCodePage.NotAvailable): Text {
                                    text: "(Not currently available)";
                                    font-family: regular_font_family;
                                    horizontal-alignment: center;
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Program output";
                        Rectangle {
                            border-width: tab_rectangle_border_width;
                            border-color: tab_rectangle_border_color;
                            VerticalLayout {
                                ScrollView {
                                    mouse-drag-pan-enabled: true;
                                    // Scroll to bottom
                                    viewport-y: 0px - self.viewport-height + self.visible-height;
                                    VerticalLayout {
                                        Text {
                                            text: program_output;
                                            wrap: word-wrap;
                                            font-size: console_body_font_size;
                                            font-family: console_font_family;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Kernel log";
                        Rectangle {
                            border-width: tab_rectangle_border_width;
                            border-color: tab_rectangle_border_color;
                            VerticalLayout {
                                ScrollView {
                                    mouse-drag-pan-enabled: true;
                                    // Scroll to bottom
                                    viewport-y: 0px - self.viewport-height + self.visible-height;
                                    VerticalLayout {
                                        Text {
                                            text: kernel_buffer;
                                            wrap: word-wrap;
                                            font-size: console_body_font_size;
                                            font-family: console_font_family;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                HorizontalLayout {
                    alignment: center;
                    spacing: root.width * 0.1;
                    Button {
                        text: "Power off";
                        width: button_width;
                        height: button_height;
                        border-radius: radius;
                        font-family: header_font_family;
                        clicked => {
                            prepare_splash_wallpaper();
                            root.power_off();
                        }
                    }

                    Button {
                        text: "Reboot";
                        width: button_width;
                        height: button_height;
                        border-radius: radius;
                        font-family: header_font_family;
                        clicked => {
                            page = Page.ShutDownSplash;
                            refresh_screen(true);
                            root.reboot();
                        }
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: short_version_string;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                        font-family: console_font_family;
                        font-size: console_body_font_size;
                        width: root.width * 0.85;
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }
            }
        }
    }

    // Make dialogs modal and make them disappear whenever the user clicks outside of them
    TouchArea {
        width: root.width;
        height: root.height;
        enabled: dialog != DialogType.None;
        clicked => {
            if !(dialog == DialogType.Toast && sticky_toast) {
                TextInputInterface.text-input-focused = false;
                dialog = DialogType.None;
            }
        }
    }

    // Toasts/dialogs
    if (dialog == DialogType.Toast): Rectangle {
        width: scaling_factor > 1 ? 0.5 * scaling_factor * root.width : 0.6 * scaling_factor * root.width;
        height: 0.07 * scaling_factor * root.height;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        border-color: black;
        border-width: dialog_rectangle_thickness;
        border-radius: radius;
        background: white;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        Text {
            text: root.dialog_message;
            font-family: "Inter";
            font-weight: 800;
        }
    }
    // Generic Confirm/Cancel dialog
    if (dialog != DialogType.None && dialog != DialogType.Toast && dialog != DialogType.WifiUI && dialog != DialogType.WifiPassphrase && dialog != DialogType.EncryptionConfirmPassword && dialog != DialogType.EncryptionChangePassword && dialog != DialogType.EncryptionNewPassword && dialog != DialogType.Brightness && dialog != DialogType.BatteryStatus && dialog != DialogType.PowerOptions): Dialog {
        border-radius: radius;
        width: 0.45 * scaling_factor * root.width;
        height: 0.3 * scaling_factor * root.height;
        x: (root.width - self.width) / 2;
        y: (root.height - self.height) / 2;
        text: root.dialog_message;
        button_font_family: header_font_family;
        cancel => {
            dialog = DialogType.None;
        }
        confirm => {
            if dialog == DialogType.SoftReset {
                soft_reset();
            }
            dialog = DialogType.None;
        }
    }
    // Wi-Fi UI dialog
    if (dialog == DialogType.WifiUI || dialog == DialogType.WifiPassphrase): Rectangle {
        border-width: dialog_rectangle_thickness;
        border-color: black;
        border-radius: radius;
        background: white;
        width: (scaling_factor == 1 && TextInputInterface.text-input-focused) ? 0.55 * scaling_factor * root.width : 0.45 * scaling_factor * root.width;
        height: (scaling_factor > 1 && TextInputInterface.text-input-focused) ? 0.3 * scaling_factor * root.height : scaling_factor > 1 ? 0.4 * scaling_factor * root.height : 0.45 * root.height;
        x: (scaling_factor > 1 || TextInputInterface.text-input-focused) ? (root.width - self.width) / 2 : root.width - self.width - layout_padding;
        y: (scaling_factor > 1 && !TextInputInterface.text-input-focused) ? (root.height - self.height) / 2 : TextInputInterface.text-input-focused ? root.height - self.height - approx_keyboard_height - space_between_keyboard_and_widget : approx_bar_height;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        if (dialog == DialogType.WifiUI): VerticalLayout {
            padding: layout_padding * dialog_sizes_multiplier;
            HorizontalLayout {
                Text {
                    text: "Wi-Fi";
                    font-family: header_font_family;
                    font-weight: 800;
                    vertical-alignment: center;
                }

                Rectangle { }

                IconButton {
                    icon: @image-url("../../icons/refresh.svg");
                    border-radius: radius;
                    height: button_height * 0.65;
                    width: self.height;
                    y: (parent.height - self.height) / 2;
                    padding-value: bar_icon_button_padding * 0.2;
                    visible: wifi_enabled && !wifi_disabling_lock;
                    enabled: !wifi_scanning_lock && !wifi_connecting_lock;
                    clicked => {
                        get_networks();
                    }
                }

                VLine {
                    left-padding-multiplier: 2.5;
                    right-padding-multiplier: 5.0;
                    visible: wifi_enabled && !wifi_disabling_lock;
                }

                Switch {
                    y: (parent.height - self.height) / 2;
                    width: switch_width;
                    height: switch_height;
                    border-radius: radius;
                    activated: wifi_enabled;
                    enabled: !wifi_enabling_lock && !wifi_disabling_lock;
                    toggled => {
                        toggle_wifi();
                    }
                }
            }

            HLine {
                top-padding-multiplier: 4.0;
                bottom-padding-multiplier: self.top-padding-multiplier;
            }

            if (wifi_enabled && !wifi_scanning_lock && !wifi_connecting_lock && !wifi_enabling_lock && !wifi_disabling_lock): ScrollView {
                mouse-drag-pan-enabled: true;
                VerticalLayout {
                    spacing: layout_spacing;
                    // Wi-Fi button(s)
                    for name[index] in wifi_network_names: i-network-button := TouchArea {
                        i-network-container := Rectangle {
                            border-radius: radius;
                            border-width: 3px;
                            border-color: item_border_color;
                            background: name == wifi_connected_name ? item_selected_color : #ffffff;

                            HorizontalLayout {
                                padding: 20px;
                                spacing: layout_spacing;

                                i-network-text := Text {
                                    color: #000000;
                                    horizontal-alignment: left;
                                    vertical-alignment: center;
                                    font-family: regular_font_family;
                                    font-size: root.default-font-size * dialog_sizes_multiplier;
                                    text: name;
                                    wrap: word-wrap;
                                }

                                Rectangle { }

                                VerticalLayout {
                                    alignment: center;
                                    HorizontalLayout {
                                        spacing: layout_spacing;
                                        if (name == wifi_connected_name): Image {
                                            source: @image-url("../../icons/wifi-connected-alt.svg");
                                            height: icon_button_height;
                                            width: self.height;
                                            colorize: i-network-button.pressed ? #ffffff : #000000;
                                        }
                                        if (wifi_network_open_vec[index]): Image {
                                            source: @image-url("../../icons/wifi-network-open.svg");
                                            height: icon_button_height;
                                            width: self.height;
                                            colorize: i-network-button.pressed ? #ffffff : #000000;
                                        }
                                        if (!wifi_network_open_vec[index]): Image {
                                            source: @image-url("../../icons/wifi-network-locked.svg");
                                            height: icon_button_height;
                                            width: self.height;
                                            colorize: i-network-button.pressed ? #ffffff : #000000;
                                        }
                                    }
                                }
                            }
                        }

                        states [
                            pressed when self.pressed: {
                                i-network-container.background: #000000;
                                i-network-text.color: #ffffff;
                            }
                        ]

                        clicked => {
                            if name == wifi_connected_name {
                                dialog_message = "IP address: \{wifi_ip_address}";
                                dialog = DialogType.Toast;
                            } else if wifi_network_open_vec[index] {
                                connect_to_wifi_network(name, "");
                            } else {
                                potential_wifi_network = name;
                                TextInputInterface.text-input-focused = true;
                                dialog = DialogType.WifiPassphrase;
                            }
                        }
                    }
                    Rectangle { }
                }
            }
            if (!wifi_enabled && !wifi_enabling_lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Enable Wi-Fi in order to connect to a network";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
            if (wifi_enabling_lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Enabling Wi-Fi";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
            if (wifi_disabling_lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Disabling Wi-Fi";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
            if (wifi_scanning_lock && !wifi_disabling_lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Scanning for networks";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
            if (wifi_connecting_lock && !wifi_disabling_lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Connecting to network";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
        }
        if (dialog == DialogType.WifiPassphrase): VerticalLayout {
            padding: layout_padding;
            HorizontalLayout {
                IconButton {
                    icon: @image-url("../../icons/arrow-back.svg");
                    border-radius: radius;
                    height: icon_button_height;
                    width: self.height;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        TextInputInterface.text-input-focused = false;
                        dialog = DialogType.WifiUI;
                    }
                }

                Text {
                    text: "Enter passphrase";
                    font-family: header_font_family;
                    font-size: root.default-font-size * dialog_sizes_multiplier;
                    font-weight: 800;
                    wrap: word-wrap;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                Rectangle {
                    height: icon_button_height;
                    width: self.height;
                    y: (parent.height - self.height) / 2;
                }
            }

            HLine {
                top-padding-multiplier: 4.0;
                bottom-padding-multiplier: self.top-padding-multiplier;
            }

            wifi-passphrase-edit := LineEdit {
                default-height: parent.height * 0.08;
                scaling-factor: scaling_factor;
                border-radius: radius;
                placeholder-text: "Passphrase for “\{potential_wifi_network}”";
                font-size: root.default-font-size * dialog_sizes_multiplier;
                input-type: password;
            }

            Rectangle { }

            Button {
                width: 100%;
                height: button_height * dialog_sizes_multiplier;
                font-family: header_font_family;
                font-size: root.default-font-size * dialog_sizes_multiplier;
                border-radius: radius;
                text: "Connect";
                clicked => {
                    TextInputInterface.text-input-focused = false;
                    dialog = DialogType.WifiUI;
                    connect_to_wifi_network(potential_wifi_network, wifi-passphrase-edit.text);
                }
            }
        }
    }
    // Storage encryption passphrase dialog
    if (dialog == DialogType.EncryptionConfirmPassword || dialog == DialogType.EncryptionChangePassword || dialog == DialogType.EncryptionNewPassword): Rectangle {
        border-width: dialog_rectangle_thickness;
        border-color: black;
        border-radius: radius;
        background: white;
        width: scaling_factor > 1 ? root.width * 0.65 : root.width * 0.45;
        height: scaling_factor > 1 ? root.height * 0.5 : root.height * 0.4;
        x: (root.width - self.width) / 2;
        y: root.height - self.height - approx_keyboard_height - space_between_keyboard_and_widget;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        VerticalLayout {
            padding: layout_padding;
            HorizontalLayout {
                IconButton {
                    icon: @image-url("../../icons/arrow-back.svg");
                    border-radius: radius;
                    height: icon_button_height;
                    width: self.height;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        TextInputInterface.text-input-focused = false;
                        dialog = DialogType.None;
                    }
                }

                Text {
                    text: dialog == DialogType.EncryptionChangePassword ? "Changing password" : dialog == DialogType.EncryptionConfirmPassword ? "Confirming password" : "Setting password";
                    font-family: header_font_family;
                    font-size: root.default-font-size * dialog_sizes_multiplier;
                    font-weight: 800;
                    wrap: word-wrap;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                Rectangle {
                    height: icon_button_height;
                    width: self.height;
                    y: (parent.height - self.height) / 2;
                }
            }

            HLine {
                top-padding-multiplier: 4.0;
                bottom-padding-multiplier: self.top-padding-multiplier;
            }

            encryption-current-password-edit := LineEdit {
                default-height: dialog == DialogType.EncryptionChangePassword || dialog == DialogType.EncryptionConfirmPassword ? parent.height * 0.08 : 0;
                scaling-factor: scaling_factor;
                border-radius: radius;
                font-size: root.default-font-size * dialog_sizes_multiplier;
                placeholder-text: "Current password";
                input-type: password;
                visible: dialog != DialogType.EncryptionNewPassword;
            }

            Rectangle {
                vertical-stretch: dialog == DialogType.EncryptionChangePassword ? 0.05 : 0;
            }

            encryption-new-password-edit := LineEdit {
                default-height: parent.height * 0.08;
                scaling-factor: scaling_factor;
                border-radius: radius;
                font-size: root.default-font-size * dialog_sizes_multiplier;
                placeholder-text: "New password";
                visible: dialog == DialogType.EncryptionChangePassword || dialog == DialogType.EncryptionNewPassword;
                input-type: password;
            }

            Rectangle {
                vertical-stretch: 0.05;
                visible: dialog == DialogType.EncryptionChangePassword;
            }

            encryption-confirm-password-edit := LineEdit {
                default-height: parent.height * 0.08;
                scaling-factor: scaling_factor;
                border-radius: radius;
                font-size: root.default-font-size * dialog_sizes_multiplier;
                placeholder-text: "Confirm new password";
                visible: dialog == DialogType.EncryptionChangePassword || dialog == DialogType.EncryptionNewPassword;
                input-type: password;
            }

            Rectangle { }

            Button {
                width: 100%;
                height: button_height * dialog_sizes_multiplier;
                font-family: header_font_family;
                font-size: root.default-font-size * dialog_sizes_multiplier;
                border-radius: radius;
                text: "Confirm";
                clicked => {
                    if encryption-current-password-edit.text.is-empty && dialog != DialogType.EncryptionNewPassword {
                        dialog_message = "Please provide current password";
                        dialog = DialogType.Toast;
                    } else if encryption-new-password-edit.text != encryption-confirm-password-edit.text && (dialog == DialogType.EncryptionChangePassword || dialog == DialogType.EncryptionNewPassword) {
                        dialog_message = "Passwords do not match";
                        dialog = DialogType.Toast;
                    } else if encryption-new-password-edit.text == encryption-confirm-password-edit.text && encryption-new-password-edit.text.is-empty && (dialog == DialogType.EncryptionChangePassword || dialog == DialogType.EncryptionNewPassword) {
                        dialog_message = "Cannot set empty password";
                        dialog = DialogType.Toast;
                    } else {
                        if dialog == DialogType.EncryptionChangePassword || dialog == DialogType.EncryptionNewPassword {
                            dialog_message = "Setting password";
                        } else if dialog == DialogType.EncryptionConfirmPassword {
                            dialog_message = "Disabling encrypted storage"
                        }
                        if dialog == DialogType.EncryptionChangePassword || dialog == DialogType.EncryptionNewPassword {
                            change_user_password(selected_encryption_user.name, encryption-current-password-edit.text, encryption-new-password-edit.text, !selected_encryption_user.encryption);
                        } else if dialog == DialogType.EncryptionConfirmPassword {
                            disable_storage_encryption(selected_encryption_user.name, encryption-current-password-edit.text);
                        }
                        sticky_toast = true;
                        dialog = DialogType.Toast;
                    }
                    TextInputInterface.text-input-focused = false;
                }
            }
        }
    }
    // Brightness dialog
    if (dialog == DialogType.Brightness): Rectangle {
        border-width: dialog_rectangle_thickness;
        border-color: black;
        border-radius: radius;
        background: white;
        width: root.width * 0.5;
        height: layout_padding + 2 * icon_button_height + layout_spacing * 2 + layout_padding;
        x: scaling_factor > 1 ? (root.width - self.width) / 2 : root.width - self.width - layout_padding;
        y: scaling_factor > 1 ? (root.height - self.height) / 2 : approx_bar_height;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        VerticalLayout {
            padding: layout_padding;
            spacing: layout_spacing * 2;
            HorizontalLayout {
                spacing: layout_spacing * 2;
                VerticalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../icons/brightness.svg");
                        width: icon_button_height;
                        height: self.width;
                    }
                }

                VerticalLayout {
                    alignment: center;
                    Slider {
                        height: slider_height;
                        value: cool_brightness;
                        changed(value) => {
                            change_cool_brightness(value);
                        }
                    }
                }
            }

            HorizontalLayout {
                spacing: layout_spacing * 2;
                VerticalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../icons/moon.svg");
                        width: icon_button_height;
                        height: self.width;
                    }
                }

                VerticalLayout {
                    alignment: center;
                    Slider {
                        height: slider_height;
                        value: warm_brightness;
                        changed(value) => {
                            change_warm_brightness(value);
                        }
                    }
                }
            }
        }
    }
    // Battery status dialog
    if (dialog == DialogType.BatteryStatus): Rectangle {
        border-width: dialog_rectangle_thickness;
        border-color: black;
        border-radius: radius;
        background: white;
        width: scaling_factor > 1 ? root.width * 0.65 : root.width * 0.35;
        height: scaling_factor > 1 ? root.height * 0.15 : root.height * 0.1;
        x: scaling_factor > 1 ? (root.width - self.width) / 2 : root.width - self.width - layout_padding;
        y: scaling_factor > 1 ? (root.height - self.height) / 2 : approx_bar_height;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        VerticalLayout {
            padding: layout_padding;
            spacing: layout_spacing * 2;
            HorizontalLayout {
                Text {
                    text: "Status";
                    font-family: header_font_family;
                    font-size: root.default-font-size * dialog_sizes_multiplier * 0.95;
                    font-weight: 800;
                    vertical-alignment: center;
                }

                Rectangle { }

                Text {
                    text: charger_plugged_in ? "Charging" : "Discharging";
                    font-family: regular_font_family;
                    font-size: root.default-font-size * dialog_sizes_multiplier;
                    vertical-alignment: center;
                }
            }

            HorizontalLayout {
                Text {
                    text: "Charge level";
                    font-family: header_font_family;
                    font-size: root.default-font-size * dialog_sizes_multiplier * 0.95;
                    font-weight: 800;
                    vertical-alignment: center;
                }

                Rectangle { }

                Text {
                    text: "\{battery_level} %";
                    font-family: regular_font_family;
                    font-size: root.default-font-size * dialog_sizes_multiplier;
                    vertical-alignment: center;
                }
            }
        }
    }
    // Power options dialog
    if (dialog == DialogType.PowerOptions): Rectangle {
        border-width: dialog_rectangle_thickness;
        border-color: black;
        border-radius: radius;
        background: white;
        width: scaling_factor > 1 ? root.width * 0.65 : root.width * 0.35;
        height: button_height * dialog_sizes_multiplier * 2 + layout_padding * 2 + layout_spacing * 2;
        x: scaling_factor > 1 ? (root.width - self.width) / 2 : root.width - self.width - layout_padding;
        y: scaling_factor > 1 ? (root.height - self.height) / 2 : approx_bar_height;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        VerticalLayout {
            padding: layout_padding;
            spacing: layout_spacing * 2;
            Button {
                width: 100%;
                height: button_height * dialog_sizes_multiplier;
                font-family: header_font_family;
                font-size: root.default-font-size * dialog_sizes_multiplier;
                border-radius: radius;
                text: "Power off";
                clicked => {
                    TextInputInterface.text-input-focused = false;
                    dialog = DialogType.None;
                    if page == Page.UserLogin {
                        shutdown_command = RootFsShutDownCommand.PowerOff;
                        prepare_splash_wallpaper();
                        if startup_finished {
                            direct_power_off();
                        }
                    } else {
                        prepare_splash_wallpaper();
                        power_off();
                    }
                }
            }

            Button {
                width: 100%;
                height: button_height * dialog_sizes_multiplier;
                font-family: header_font_family;
                font-size: root.default-font-size * dialog_sizes_multiplier;
                border-radius: radius;
                text: "Reboot";
                clicked => {
                    TextInputInterface.text-input-focused = false;
                    dialog = DialogType.None;
                    if page == Page.UserLogin {
                        page = Page.ShutDownSplash;
                        refresh_screen(true);
                        shutdown_command = RootFsShutDownCommand.Reboot;
                        if startup_finished {
                            direct_reboot();
                        }
                    } else {
                        page = Page.ShutDownSplash;
                        refresh_screen(true);
                        reboot();
                    }
                }
            }
        }
    }

    // Virtual keyboard
    ScrollView {
        VerticalLayout {
            alignment: end;
            visible: TextInputInterface.text-input-focused;
            changed visible => {
                if (self.visible == false) {
                    VirtualKeyboardHandler.current-key-set = 0;
                    i-keyboard.shift = false;
                }
            }
            i-keyboard := VirtualKeyboard {
                font-family: header_font_family;
                radius: radius;
                key-height: keyboard_key_height;
                scaling-factor: scaling_factor;
                close => {
                    TextInputInterface.text-input-focused = false;
                    if (dialog == DialogType.WifiPassphrase) {
                        dialog = DialogType.WifiUI;
                    } else {
                        dialog = DialogType.None;
                    }
                }
            }
        }
    }
}
