import { ProgressBar } from "../../ui-common/progressbar.slint";
import { Button } from "../../ui-common/button.slint";
import { IconButton } from "../../ui-common/iconbutton.slint";
import { Switch } from "../../ui-common/switch.slint";
import { ScrollView, TabWidget, TextEdit } from "std-widgets.slint";
import { MovingDots } from "../../ui-common/moving-dots.slint";
import { HLine } from "../../ui-common/hline.slint";
import { VLine } from "../../ui-common/vline.slint";
import { Dialog } from "../../ui-common/dialog.slint";
import { SectionButton } from "../../ui-common/sectionbutton.slint";
import { LineEdit } from "../../ui-common/lineedit.slint";
import { Slider } from "../../ui-common/slider.slint";
import {
    VirtualKeyboard,
    VirtualKeyboardHandler,
    KeyModel,
} from "../../ui-common/virtual_keyboard/virtual_keyboard.slint";
import { HList } from "../../ui-common/hlist.slint";
import { Properties as P } from "../../ui-common/properties.slint";

export enum Page { None, QuillBoot, VersionInfo, BootSplash, Options, BootConfiguration, RecoveryOptions, UserLogin, InvalidBootConfig, Error, ShutDownSplash }
export enum QrCodePage { QrCode, NotAvailable }
export enum ProgressWidget { ProgressBar, MovingDots }
export enum DialogType { None, Toast, SoftReset, WifiUI, WifiPassphrase, Brightness, BatteryStatus, PowerOptions }
export enum RootFsShutDownCommand { None, PowerOff, Reboot }
export { VirtualKeyboardHandler, KeyModel }

export component AppWindow inherits Window {
    // Scaling
    in-out property <float> scaling-factor <=> P.scaling-factor;
    // Root properties
    default-font-family <=> P.regular-font-family;
    default-font-size <=> P.default-font-size;
    background: #ffffff;
    page: Page.None;
    // Callbacks
    callback power-off();
    callback direct-power-off();
    callback reboot();
    callback direct-reboot();
    callback toggle-ui-scale();
    callback toggle-persistent-rootfs();
    callback toggle-wifi();
    callback boot-default();
    callback soft-reset();
    callback get-networks();
    callback connect-to-wifi-network(string, string);
    callback set-brightness-sliders-levels;
    callback change-cool-brightness(int);
    callback change-warm-brightness(int);
    callback login(string, string);
    callback change-initial-screen-rotation(int);
    callback change-splash-wallpaper-model(string);
    callback change-timezone(string);
    callback generate-splash-wallpaper(bool);
    callback refresh-screen(bool);
    callback launch-core-settings();
    // In-out properties
    in-out property <string> version-string;
    in-out property <string> short-version-string;
    in-out property <float> boot-progress;
    in-out property <Page> page;
    in-out property <QrCodePage> qr-code-page;
    in-out property <ProgressWidget> progress-widget;
    in-out property <DialogType> dialog;
    in-out property <string> dialog-message;
    in-out property <int> dialog-millis-count;
    in-out property <float> button-scaling-multiplier: 1;
    in-out property <bool> startup-finished: false;
    in-out property <string> error-reason;
    in-out property <string> program-output;
    in-out property <string> kernel-buffer;
    in-out property <image> debug-qr-code;
    in-out property <image> help-uri-qr-code;
    in-out property <image> splash-wallpaper;
    in-out property <int> debug-tab-index: 0;
    in-out property <string> section-header-title;
    in-out property <image> wifi-icon: @image-url("../../icons/wifi-init.svg");
    in-out property <image> core-settings-button-icon: @image-url("../../icons/settings.svg");
    in-out property <image> battery-icon;
    in-out property <bool> sticky-toast: false;
    property <[string]> orientations-list: ["0", "90", "180", "270"];
    in property <[string]> splash-wallpaper-models-list;
    in property <[string]> timezones-list;
    in-out property <int> orientations-list-index: 3;
    in-out property <int> splash-wallpaper-models-list-index;
    in-out property <int> timezones-list-index;
    // Configuration properties
    in-out property <bool> persistent-rootfs;
    in property <bool> recovery-features;
    // Run-time properties
    in property <bool> wifi-enabled;
    in property <bool> wifi-connected;
    in property <bool> wifi-scanning-lock;
    in property <bool> wifi-connecting-lock;
    in property <bool> wifi-enabling-lock;
    in property <bool> wifi-disabling-lock;
    in property <string> wifi-connected-name;
    in property <string> wifi-ip-address;
    in-out property <string> potential-wifi-network;
    in property <[string]> wifi-network-names;
    in property <[bool]> wifi-network-open-vec;
    in property <string> current-time;
    in property <int> cool-brightness;
    in property <int> warm-brightness;
    in property <int> battery-level;
    in property <bool> charger-plugged-in;
    in property <string> default-user: "";
    in property <bool> login-captive-portal: false;
    in property <bool> quill-recovery;
    out property <RootFsShutDownCommand> shutdown-command: RootFsShutDownCommand.None;
    in property <string> splash-wallpaper-text;
    in property <string> splash-wallpaper-date-time-information;
    in property <bool> enable-ui: true;
    in property <string> max-copyright-year;
    // Generic multipliers for default-sized and smaller-sized items
    property <float> wmultiplier <=> P.wmultiplier;
    property <float> hmultiplier <=> P.hmultiplier;
    property <float> swmultiplier <=> P.swmultiplier;
    property <float> shmultiplier <=> P.shmultiplier;
    property <float> dialog-sizes-multiplier <=> P.dialog-sizes-multiplier;
    // Default sizes/radii/properties; there may be elements that don't enforce them for various reasons
    property <relative-font-size> header-font-size <=> P.header-font-size;
    property <length> layout-padding <=> P.layout-padding;
    property <length> layout-spacing <=> P.layout-spacing;
    property <length> button-width <=> P.button-width;
    property <length> button-height <=> P.button-height;
    property <length> icon-button-height <=> P.icon-button-height;
    property <length> bar-button-height <=> P.bar-button-height;
    property <length> slider-height <=> P.slider-height;
    property <length> section-button-height <=> P.section-button-height;
    property <length> switch-width <=> P.switch-width;
    property <length> switch-height <=> P.switch-height;
    property <length> radius <=> P.radius;
    property <length> logo-width <=> P.logo-width;
    property <length> logo-height <=> P.logo-height;
    property <length> medium-logo-width <=> P.medium-logo-width;
    property <length> medium-logo-height <=> P.medium-logo-height;
    property <string> header-font-family <=> P.header-font-family;
    property <string> console-font-family <=> P.console-font-family;
    property <string> regular-font-family <=> P.regular-font-family;
    property <length> console-header-font-size <=> P.console-header-font-size;
    property <length> console-body-font-size <=> P.console-body-font-size;
    property <length> tab-rectangle-border-width <=> P.tab-rectangle-border-width;
    property <color> tab-rectangle-border-color <=> P.tab-rectangle-border-color;
    property <length> dialog-rectangle-thickness <=> P.dialog-rectangle-thickness;
    property <length> keyboard-key-height <=> P.keyboard-key-height;
    property <length> approx-keyboard-height <=> P.approx-keyboard-height;
    property <length> approx-bar-height <=> P.approx-bar-height;
    property <length> bar-icon-button-padding <=> P.bar-icon-button-padding;
    property <length> space-between-keyboard-and-widget <=> P.space-between-keyboard-and-widget;
    property <color> item-border-color <=> P.item-border-color;
    property <color> item-selected-color <=> P.item-selected-color;
    property <string> version-info-header <=> P.version-info-header;

    function prepare-splash-wallpaper() {
        generate-splash-wallpaper(false);
        page = Page.ShutDownSplash;
    }

    public function standard-reboot() {
        dialog = DialogType.None;
        page = Page.ShutDownSplash;
        refresh-screen(true);
        root.reboot();
    }

    public function set-background-color(color: color) {
        self.background = color;
    }

    if (page == Page.ShutDownSplash): VerticalLayout {
        Image {
            source: splash-wallpaper;
            width: root.width;
            height: root.height;
        }
    }

    if (page == Page.ShutDownSplash): VerticalLayout {
        alignment: center;
        HorizontalLayout {
            alignment: center;
            Rectangle {
                border-radius: radius * 2.5;
                border-color: black;
                background: white;
                border-width: 10px;
                width: scaling-factor * root.width * 0.5;
                height: scaling-factor * root.height * 0.145;
                HorizontalLayout {
                    Rectangle {
                        width: (layout-spacing * 2.5 + parent.width * 0.025) * 0.725;
                    }

                    Image {
                        source: @image-url("../../../branding/quillos.svg");
                        width: root.width * 0.15;
                        height: self.width;
                        y: (parent.height - self.height) / 2;
                    }

                    Rectangle {
                        width: parent.width * 0.025;
                    }

                    VerticalLayout {
                        alignment: center;
                        Text {
                            text: splash-wallpaper-text;
                            font-family: header-font-family;
                            font-size: header-font-size * 0.55;
                            font-weight: 800;
                            vertical-alignment: center;
                            horizontal-alignment: center;
                        }

                        HLine {
                            top-padding-multiplier: 4.5;
                            bottom-padding-multiplier: self.top-padding-multiplier;
                        }

                        HorizontalLayout {
                            alignment: center;
                            Image {
                                source: @image-url("../../icons/clock.svg");
                                height: root.height * scaling-factor * 0.025;
                                width: self.height;
                                y: (parent.height - self.height) / 2;
                            }

                            Rectangle {
                                width: layout-spacing * 0.8;
                            }

                            Text {
                                text: splash-wallpaper-date-time-information;
                                font-size: header-font-size * 0.46;
                                vertical-alignment: center;
                            }

                            Rectangle {
                                width: scaling-factor * 37.5px + layout-spacing * 0.8;
                            }

                            Image {
                                source: battery-icon;
                                height: root.height * scaling-factor * 0.03;
                                width: self.height;
                                y: (parent.height - self.height) / 2;
                            }

                            Rectangle {
                                width: layout-spacing * 1.3;
                            }

                            Text {
                                text: "\{battery-level} %";
                                font-size: header-font-size * 0.46;
                                vertical-alignment: center;
                            }
                        }
                    }

                    Rectangle {
                        width: parent.width * 0.065;
                    }
                }
            }
        }
    }

    // Main UI
    // Don't ask me why a ScrollView is needed here to prevent binding loops...
    ScrollView {
        VerticalLayout {
            padding: layout-padding;
            spacing: layout-spacing;
            if (page != Page.QuillBoot) && (page != Page.BootSplash) && (page != Page.ShutDownSplash) && (page != Page.UserLogin) && (page != Page.None) && (page != Page.InvalidBootConfig) && (page != Page.Error): HorizontalLayout {
                IconButton {
                    icon: @image-url("../../icons/arrow-back.svg");
                    border-radius: radius;
                    height: icon-button-height;
                    width: self.height;
                    /* This is needed to center this item vertically on the horizontal layout.
                        It would be great if Slint provided an option to do it automatically instead... */
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        if login-captive-portal {
                            root.page = Page.UserLogin;
                        } else if root.page == Page.Options || root.page == Page.VersionInfo {
                            root.page = Page.QuillBoot;
                        } else if root.page == Page.RecoveryOptions || root.page == Page.BootConfiguration {
                            section-header-title = "Options";
                            root.page = Page.Options;
                        }
                    }
                }

                Rectangle { }

                Text {
                    text: section-header-title;
                    horizontal-alignment: center;
                    font-family: header-font-family;
                    font-weight: 800;
                    y: (parent.height - self.height) / 2;
                }

                Rectangle { }

                Rectangle {
                    height: icon-button-height;
                    width: self.height;
                }
            }
            if (page == Page.QuillBoot || page == Page.UserLogin): HorizontalLayout {
                spacing: layout-spacing * 1.5;
                Text {
                    text: current-time;
                    vertical-alignment: center;
                    font-family: header-font-family;
                    font-weight: 800;
                }

                Rectangle { }

                if (page != Page.UserLogin): IconButton {
                    icon: wifi-icon;
                    border-radius: radius;
                    height: bar-button-height;
                    width: self.height;
                    padding-value: bar-icon-button-padding;
                    background-color: dialog == DialogType.WifiUI ? #000000 : #ffffff;
                    y: (parent.height - self.height) / 2;
                    enabled: wifi-icon == @image-url("../../icons/wifi-init.svg") ? false : true;
                    clicked => {
                        dialog = DialogType.WifiUI;
                    }
                }

                if (page == Page.UserLogin): IconButton {
                    icon: @image-url("../../icons/info.svg");
                    border-radius: radius;
                    height: bar-button-height;
                    width: self.height;
                    padding-value: bar-icon-button-padding;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        TextInputInterface.text-input-focused = false;
                        section-header-title = version-info-header;
                        root.page = Page.VersionInfo;
                    }
                }

                if (page == Page.UserLogin): VLine {
                    thickness: 1px;
                    left-padding-multiplier: 0.05;
                    right-padding-multiplier: self.left-padding-multiplier;
                }

                if (page != Page.UserLogin): VLine {
                    thickness: 1px;
                    left-padding-multiplier: 0.05;
                    right-padding-multiplier: self.left-padding-multiplier;
                }

                IconButton {
                    icon: @image-url("../../icons/brightness.svg");
                    border-radius: radius;
                    height: bar-button-height;
                    width: self.height;
                    padding-value: bar-icon-button-padding;
                    background-color: dialog == DialogType.Brightness ? #000000 : #ffffff;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        set-brightness-sliders-levels();
                        dialog = DialogType.Brightness;
                    }
                }

                VLine {
                    thickness: 1px;
                    left-padding-multiplier: 0.05;
                    right-padding-multiplier: self.left-padding-multiplier;
                }

                IconButton {
                    icon: battery-icon;
                    border-radius: radius;
                    height: bar-button-height;
                    width: self.height;
                    padding-value: bar-icon-button-padding * 0.4;
                    background-color: dialog == DialogType.BatteryStatus ? #000000 : #ffffff;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        dialog = DialogType.BatteryStatus;
                    }
                }

                VLine {
                    thickness: 1px;
                    left-padding-multiplier: 0.05;
                    right-padding-multiplier: self.left-padding-multiplier;
                }

                IconButton {
                    icon: @image-url("../../icons/power.svg");
                    border-radius: radius;
                    height: bar-button-height;
                    width: self.height;
                    padding-value: bar-icon-button-padding;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        dialog = DialogType.PowerOptions;
                    }
                }
            }
            if (page != Page.BootSplash) && (page != Page.ShutDownSplash) && (page != Page.None) && (page != Page.InvalidBootConfig) && (page != Page.Error): HLine {
                top-padding-multiplier: page == Page.QuillBoot ? 0.5 : 1;
            }

            if (page == Page.QuillBoot): VerticalLayout {
                padding: layout-padding;
                Rectangle { }

                HorizontalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../../branding/quillos.svg");
                        width: root.width * 0.35;
                        height: self.width;
                    }
                }

                Rectangle { }

                HorizontalLayout {
                    Text {
                        text: "QuillBoot";
                        horizontal-alignment: center;
                        font-family: header-font-family;
                        font-size: header-font-size;
                        font-weight: 800;
                    }
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: recovery-features ? "Diagnostics & Recovery" : "Diagnostics";
                        font-size: 1rem;
                    }
                }

                Rectangle { }

                HorizontalLayout {
                    alignment: center;
                    spacing: layout-spacing * 4;
                    Button {
                        text: "Options";
                        width: button-width;
                        height: button-height;
                        border-radius: radius;
                        font-family: header-font-family;
                        clicked => {
                            section-header-title = "Options";
                            root.page = Page.Options;
                        }
                    }

                    Button {
                        text: "Quill OS";
                        width: button-width;
                        height: button-height;
                        border-radius: radius;
                        font-family: header-font-family;
                        clicked => {
                            root.boot-default();
                        }
                    }
                }

                Rectangle { }

                HorizontalLayout {
                    VerticalLayout {
                        alignment: center;
                        IconButton {
                            icon: @image-url("../../icons/info.svg");
                            height: switch-height;
                            width: self.height;
                            border-radius: radius;
                            clicked => {
                                section-header-title = version-info-header;
                                root.page = Page.VersionInfo;
                            }
                        }
                    }

                    Rectangle { }

                    Text {
                        vertical-alignment: center;
                        font-family: regular-font-family;
                        text: "Scale GUI";
                    }

                    Rectangle {
                        horizontal-stretch: 0.05;
                    }

                    Switch {
                        y: (parent.height - self.height) / 2;
                        width: switch-width;
                        height: switch-height;
                        border-radius: radius;
                        activated: scaling-factor > 1 ? true : false;
                        toggled => {
                            root.toggle-ui-scale();
                        }
                    }
                }
            }

            if (page == Page.BootSplash): VerticalLayout {
                padding-top: 550px;
                padding-bottom: self.padding-top;
                HorizontalLayout {
                    alignment: center;
                    Image {
                        width: logo-width;
                        height: logo-height;
                        source: @image-url("../../../branding/quillos.svg");
                    }
                }

                Rectangle { }

                HorizontalLayout {
                    alignment: center;
                    if (progress-widget == ProgressWidget.ProgressBar): ProgressBar {
                        progress: root.boot-progress;
                        width: 37.5%;
                        height: 2%;
                    }
                    if (progress-widget == ProgressWidget.MovingDots): Rectangle {
                        width: 14%;
                        MovingDots {
                            ready: startup-finished;
                        }
                    }
                }
            }

            if (page == Page.VersionInfo): VerticalLayout {
                spacing: layout-spacing;
                Rectangle { }

                HorizontalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../../branding/quillos.svg");
                        width: root.width * 0.25;
                        height: self.width;
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                ScrollView {
                    height: 50%;
                    mouse-drag-pan-enabled: true;
                    VerticalLayout {
                        Text {
                            text: "Quill OS";
                            horizontal-alignment: center;
                            font-family: header-font-family;
                            font-size: header-font-size;
                            font-weight: 800;
                        }

                        Rectangle {
                            vertical-stretch: 0.1;
                        }

                        Text {
                            text: "Copyright © 2021-\{max_copyright_year}";
                            horizontal-alignment: center;
                            font-family: header-font-family;
                            font-weight: 800;
                        }

                        Text {
                            text: "Nicolas Mailloux\n<nicolecrivain@gmail.com>\nSzybet\n<https://github.com/Szybet>";
                            font-family: regular-font-family;
                            font-size: root.default-font-size * 0.9;
                            horizontal-alignment: center;
                        }

                        Rectangle {
                            vertical-stretch: 0.25;
                        }

                        Text {
                            text: "Software information";
                            horizontal-alignment: center;
                            font-family: header-font-family;
                            font-weight: 800;
                        }

                        Text {
                            text: root.version-string;
                            font-size: root.default-font-size * 0.9;
                            horizontal-alignment: center;
                            wrap: word-wrap;
                        }
                    }
                }

                Rectangle { }
            }

            if (page == Page.Options): ScrollView {
                mouse-drag-pan-enabled: true;
                VerticalLayout {
                    spacing: layout-spacing;
                    if (recovery-features): SectionButton {
                        text: "Recovery options";
                        height: section-button-height;
                        border-radius: radius;
                        font-family: header-font-family;
                        scaling-factor: scaling-factor;
                        icon: @image-url("../../icons/recovery.svg");
                        clicked => {
                            if battery-level >= 50 {
                                section-header-title = self.text;
                                page = Page.RecoveryOptions;
                            } else {
                                dialog-message = "Battery level too low";
                                dialog = DialogType.Toast;
                            }
                        }
                    }

                    SectionButton {
                        text: "System & boot configuration";
                        height: section-button-height;
                        border-radius: radius;
                        font-family: header-font-family;
                        scaling-factor: scaling-factor;
                        icon: @image-url("../../icons/settings.svg");
                        clicked => {
                            section-header-title = self.text;
                            page = Page.BootConfiguration;
                        }
                    }
                }

                Rectangle { }
            }

            if (page == Page.RecoveryOptions): VerticalLayout {
                ScrollView {
                    mouse-drag-pan-enabled: true;
                    VerticalLayout {
                        spacing: layout-spacing;
                        padding-top: layout-spacing;
                        padding-bottom: layout-spacing;
                        HorizontalLayout {
                            spacing: layout-spacing;
                            padding-left: layout-padding;
                            padding-right: layout-padding;
                            Rectangle {
                                Text {
                                    text: "Soft-reset this device";
                                    font-family: regular-font-family;
                                    vertical-alignment: center;
                                }
                            }

                            Rectangle { }

                            Button {
                                text: "Soft reset";
                                width: button-width;
                                height: button-height;
                                border-radius: radius;
                                font-family: header-font-family;
                                clicked => {
                                    dialog-message = "This will erase all of the user data on this device and reset settings to default, without reinstalling the firmware. Are you sure you want to continue?";
                                    dialog = DialogType.SoftReset;
                                }
                            }
                        }
                    }

                    Rectangle { }
                }
            }

            if (page == Page.BootConfiguration): VerticalLayout {
                ScrollView {
                    mouse-drag-pan-enabled: true;
                    VerticalLayout {
                        spacing: layout-spacing;
                        padding-top: layout-spacing;
                        padding-bottom: self.padding-top;
                        HorizontalLayout {
                            padding-left: layout-padding;
                            padding-right: self.padding-left;
                            Rectangle {
                                Text {
                                    text: "Persistent root filesystem";
                                    font-family: regular-font-family;
                                    vertical-alignment: center;
                                }
                            }

                            Rectangle { }

                            Switch {
                                width: switch-width;
                                height: switch-height;
                                y: (parent.height - self.height) / 2;
                                border-radius: radius;
                                activated: persistent-rootfs;
                                toggled => {
                                    persistent-rootfs = !persistent-rootfs;
                                    toggle-persistent-rootfs();
                                }
                            }
                        }

                        HorizontalLayout {
                            padding-left: layout-padding;
                            padding-right: self.padding-left;
                            spacing: layout-spacing;
                            Rectangle {
                                Text {
                                    text: "Initial screen rotation (degrees)";
                                    font-family: regular-font-family;
                                    vertical-alignment: center;
                                }
                            }

                            Rectangle { }

                            HList {
                                border-radius: radius;
                                element-width: switch-width;
                                button-width: switch-width * 0.5 - layout-spacing * 1.35 - 2px;
                                spacing: layout-spacing;
                                height: switch-height;
                                list: orientations-list;
                                index <=> orientations-list-index;
                                index-changed(i) => {
                                    change-initial-screen-rotation(i);
                                }
                            }
                        }

                        HorizontalLayout {
                            padding-left: layout-padding;
                            padding-right: self.padding-left;
                            spacing: layout-spacing;
                            Rectangle {
                                Text {
                                    text: "Splash wallpaper model";
                                    font-family: regular-font-family;
                                    vertical-alignment: center;
                                }
                            }

                            Rectangle { }

                            HList {
                                border-radius: radius;
                                element-width: switch-width * 2.5;
                                button-width: switch-width * 0.5 - layout-spacing * 1.35 - 2px;
                                spacing: layout-spacing;
                                height: switch-height;
                                list: splash-wallpaper-models-list;
                                index <=> splash-wallpaper-models-list-index;
                                index-changed(i) => {
                                    change-splash-wallpaper-model(self.current-text);
                                }
                            }
                        }

                        HorizontalLayout {
                            padding-left: layout-padding;
                            padding-right: self.padding-left;
                            spacing: layout-spacing;
                            Rectangle {
                                Text {
                                    text: "Timezone";
                                    font-family: regular-font-family;
                                    vertical-alignment: center;
                                }
                            }

                            Rectangle { }

                            HList {
                                border-radius: radius;
                                element-width: switch-width * 5;
                                button-width: switch-width * 0.5 - layout-spacing * 1.35 - 2px;
                                spacing: layout-spacing;
                                height: switch-height;
                                list: timezones-list;
                                index <=> timezones-list-index;
                                index-changed(i) => {
                                    change-timezone(self.current-text);
                                }
                            }
                        }

                        Rectangle { }
                    }
                }
            }

            if (page == Page.UserLogin): VerticalLayout {
                alignment: center;
                HorizontalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../../branding/quillos.svg");
                        width: root.width * 0.3;
                        height: self.width;
                    }
                }

                Rectangle {
                    height: root.height * 0.05;
                }

                HorizontalLayout {
                    alignment: center;
                    IconButton {
                        icon: core-settings-button-icon;
                        border-radius: radius;
                        height: button-height;
                        width: self.height;
                        y: (parent.height - self.height) / 2;
                        padding-value: bar-icon-button-padding * 0.2;
                        clicked => {
                            launch-core-settings();
                        }
                    }

                    Rectangle {
                        width: root.width * 0.0425;
                    }

                    VerticalLayout {
                        spacing: layout-spacing * 2.5;
                        HorizontalLayout {
                            alignment: center;
                            login-user-edit := LineEdit {
                                default-height: root.height * 0.035;
                                width: scaling-factor > 1 ? root.width * 0.6 : root.width * 0.35;
                                scaling-factor: scaling-factor;
                                border-radius: radius;
                                placeholder-text: "Username";
                                text: default-user;
                                font-size: root.default-font-size * dialog-sizes-multiplier;
                                input-type: text;
                            }
                        }

                        HorizontalLayout {
                            alignment: center;
                            login-password-edit := LineEdit {
                                default-height: root.height * 0.035;
                                width: scaling-factor > 1 ? root.width * 0.6 : root.width * 0.35;
                                scaling-factor: scaling-factor;
                                border-radius: radius;
                                placeholder-text: "Password";
                                font-size: root.default-font-size * dialog-sizes-multiplier;
                                input-type: password;
                            }
                        }
                    }

                    Rectangle {
                        width: root.width * 0.035;
                    }

                    IconButton {
                        icon: @image-url("../../icons/login.svg");
                        border-radius: radius;
                        height: button-height;
                        width: self.height;
                        y: (parent.height - self.height) / 2;
                        padding-value: bar-icon-button-padding * 0.2;
                        enabled: !login-user-edit.text.is-empty;
                        clicked => {
                            TextInputInterface.text-input-focused = false;
                            login(login-user-edit.text, login-password-edit.text);
                        }
                    }
                }

                Rectangle {
                    height: root.height * 0.02;
                }

                HorizontalLayout {
                    alignment: center;
                    HorizontalLayout {
                        width: scaling-factor > 1 ? root.width * 0.6 : root.width * 0.35;
                        Text {
                            font-family: regular-font-family;
                            text: "Scale GUI";
                            font-size: root.default-font-size * dialog-sizes-multiplier;
                            vertical-alignment: center;
                        }

                        Rectangle { }

                        Switch {
                            y: (parent.height - self.height) / 2;
                            width: switch-width * dialog-sizes-multiplier;
                            height: switch-height * dialog-sizes-multiplier;
                            border-radius: radius;
                            activated: scaling-factor > 1 ? true : false;
                            toggled => {
                                root.toggle-ui-scale();
                            }
                        }
                    }
                }

                if (TextInputInterface.text-input-focused): Rectangle {
                    height: root.height * 0.25;
                }
            }

            if (page == Page.InvalidBootConfig): VerticalLayout {
                alignment: center;
                spacing: layout-spacing;
                HorizontalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../icons/warning.svg");
                        width: logo-width * 0.9;
                        height: self.width;
                    }
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: "Warning";
                        horizontal-alignment: center;
                        font-family: header-font-family;
                        font-size: header-font-size;
                        font-weight: 800;
                    }
                }

                Rectangle {
                    height: root.height * 0.025;
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: "The boot configuration which was found on this device is invalid: it might possibly have been corrupted. A new, working one has been written for reference alongside the current one.\n\nPress 'Continue' to overwrite the current configuration (leaving a backup in place) and replace it with the default one.\n\nPress 'Power off' to edit the configuration manually on your computer and retry the boot process again.";
                        width: root.width * 0.55;
                        wrap: word-wrap;
                        horizontal-alignment: center;
                    }
                }

                Rectangle {
                    height: root.height * 0.05;
                }

                HorizontalLayout {
                    alignment: center;
                    spacing: layout-spacing * 4;
                    Button {
                        text: "Power off";
                        width: button-width;
                        height: button-height;
                        border-radius: radius;
                        font-family: header-font-family;
                        clicked => {
                            prepare-splash-wallpaper();
                            direct-power-off();
                        }
                    }

                    Button {
                        text: "Continue";
                        width: button-width;
                        height: button-height;
                        border-radius: radius;
                        font-family: header-font-family;
                        clicked => {
                            if quill-recovery {
                                root.page = Page.QuillBoot;
                            } else {
                                boot-default();
                            }
                        }
                    }
                }
            }

            if (page == Page.Error): VerticalLayout {
                padding-left: layout-padding;
                padding-right: layout-padding;
                Rectangle {
                    vertical-stretch: 0.1;
                }

                HorizontalLayout {
                    alignment: center;
                    spacing: root.width * 0.04;
                    Image {
                        source: @image-url("../../icons/x-alert.svg");
                        width: medium-logo-width;
                        height: medium-logo-height;
                    }

                    Image {
                        source: help-uri-qr-code;
                        width: medium-logo-width;
                        height: medium-logo-height;
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                Text {
                    text: "Fatal error";
                    horizontal-alignment: center;
                    font-family: header-font-family;
                    font-size: header-font-size;
                    font-weight: 800;
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: error-reason;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                        font-family: console-font-family;
                        font-size: console-header-font-size;
                        width: root.width * 0.7;
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                TabWidget {
                    current-index: debug-tab-index;
                    Tab {
                        title: "Debug QR code";
                        Rectangle {
                            border-width: tab-rectangle-border-width;
                            border-color: tab-rectangle-border-color;
                            VerticalLayout {
                                alignment: center;
                                if (qr-code-page == QrCodePage.QrCode): Image {
                                    source: debug-qr-code;
                                    height: 99%;
                                }
                                if (qr-code-page == QrCodePage.NotAvailable): Text {
                                    text: "(Not currently available)";
                                    font-family: regular-font-family;
                                    horizontal-alignment: center;
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Program output";
                        Rectangle {
                            border-width: tab-rectangle-border-width;
                            border-color: tab-rectangle-border-color;
                            VerticalLayout {
                                ScrollView {
                                    mouse-drag-pan-enabled: true;
                                    // Scroll to bottom
                                    viewport-y: 0px - self.viewport-height + self.visible-height;
                                    VerticalLayout {
                                        Text {
                                            text: program-output;
                                            wrap: word-wrap;
                                            font-size: console-body-font-size;
                                            font-family: console-font-family;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Kernel log";
                        Rectangle {
                            border-width: tab-rectangle-border-width;
                            border-color: tab-rectangle-border-color;
                            VerticalLayout {
                                ScrollView {
                                    mouse-drag-pan-enabled: true;
                                    // Scroll to bottom
                                    viewport-y: 0px - self.viewport-height + self.visible-height;
                                    VerticalLayout {
                                        Text {
                                            text: kernel-buffer;
                                            wrap: word-wrap;
                                            font-size: console-body-font-size;
                                            font-family: console-font-family;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                HorizontalLayout {
                    alignment: center;
                    spacing: root.width * 0.1;
                    Button {
                        text: "Power off";
                        width: button-width;
                        height: button-height;
                        border-radius: radius;
                        font-family: header-font-family;
                        clicked => {
                            prepare-splash-wallpaper();
                            root.power-off();
                        }
                    }

                    Button {
                        text: "Reboot";
                        width: button-width;
                        height: button-height;
                        border-radius: radius;
                        font-family: header-font-family;
                        clicked => {
                            standard-reboot();
                        }
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }

                HorizontalLayout {
                    alignment: center;
                    Text {
                        text: short-version-string;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                        font-family: console-font-family;
                        font-size: console-body-font-size;
                        width: root.width * 0.85;
                    }
                }

                Rectangle {
                    vertical-stretch: 0.1;
                }
            }
        }
    }

    // Make dialogs modal and make them disappear whenever the user clicks outside of them
    TouchArea {
        width: root.width;
        height: root.height;
        enabled: dialog != DialogType.None;
        clicked => {
            if !(dialog == DialogType.Toast && sticky-toast) {
                TextInputInterface.text-input-focused = false;
                dialog = DialogType.None;
            }
        }
    }

    // Toasts/dialogs
    if (dialog == DialogType.Toast): Rectangle {
        width: scaling-factor > 1 ? 0.5 * scaling-factor * root.width : 0.6 * scaling-factor * root.width;
        height: 0.07 * scaling-factor * root.height;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        border-color: black;
        border-width: dialog-rectangle-thickness;
        border-radius: radius;
        background: white;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        Text {
            text: root.dialog-message;
            font-family: "Inter";
            font-weight: 800;
        }
    }
    // Generic Confirm/Cancel dialog
    if (dialog != DialogType.None && dialog != DialogType.Toast && dialog != DialogType.WifiUI && dialog != DialogType.WifiPassphrase && dialog != DialogType.Brightness && dialog != DialogType.BatteryStatus && dialog != DialogType.PowerOptions): Dialog {
        border-radius: radius;
        width: 0.45 * scaling-factor * root.width;
        height: 0.3 * scaling-factor * root.height;
        x: (root.width - self.width) / 2;
        y: (root.height - self.height) / 2;
        text: root.dialog-message;
        button-font-family: header-font-family;
        cancel => {
            dialog = DialogType.None;
        }
        confirm => {
            if dialog == DialogType.SoftReset {
                dialog-message = "Soft reset in progress";
                dialog = DialogType.Toast;
                soft-reset();
            }
        }
    }
    // Wi-Fi UI dialog
    if (dialog == DialogType.WifiUI || dialog == DialogType.WifiPassphrase): Rectangle {
        border-width: dialog-rectangle-thickness;
        border-color: black;
        border-radius: radius;
        background: white;
        width: (scaling-factor == 1 && TextInputInterface.text-input-focused) ? 0.55 * scaling-factor * root.width : 0.45 * scaling-factor * root.width;
        height: (scaling-factor > 1 && TextInputInterface.text-input-focused) ? 0.3 * scaling-factor * root.height : scaling-factor > 1 ? 0.4 * scaling-factor * root.height : 0.45 * root.height;
        x: (scaling-factor > 1 || TextInputInterface.text-input-focused) ? (root.width - self.width) / 2 : root.width - self.width - layout-padding;
        y: (scaling-factor > 1 && !TextInputInterface.text-input-focused) ? (root.height - self.height) / 2 : TextInputInterface.text-input-focused ? root.height - self.height - approx-keyboard-height - space-between-keyboard-and-widget : approx-bar-height;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        if (dialog == DialogType.WifiUI): VerticalLayout {
            padding: layout-padding * dialog-sizes-multiplier;
            HorizontalLayout {
                Text {
                    text: "Wi-Fi";
                    font-family: header-font-family;
                    font-weight: 800;
                    vertical-alignment: center;
                }

                Rectangle { }

                IconButton {
                    icon: @image-url("../../icons/refresh.svg");
                    border-radius: radius;
                    height: button-height * 0.65;
                    width: self.height;
                    y: (parent.height - self.height) / 2;
                    padding-value: bar-icon-button-padding * 0.2;
                    visible: wifi-enabled && !wifi-disabling-lock;
                    enabled: !wifi-scanning-lock && !wifi-connecting-lock;
                    clicked => {
                        get-networks();
                    }
                }

                VLine {
                    left-padding-multiplier: 2.5;
                    right-padding-multiplier: 5.0;
                    visible: wifi-enabled && !wifi-disabling-lock;
                }

                Switch {
                    y: (parent.height - self.height) / 2;
                    width: switch-width;
                    height: switch-height;
                    border-radius: radius;
                    activated: wifi-enabled;
                    enabled: !wifi-enabling-lock && !wifi-disabling-lock;
                    toggled => {
                        toggle-wifi();
                    }
                }
            }

            HLine {
                top-padding-multiplier: 4.0;
                bottom-padding-multiplier: self.top-padding-multiplier;
            }

            if (wifi-enabled && !wifi-scanning-lock && !wifi-connecting-lock && !wifi-enabling-lock && !wifi-disabling-lock): ScrollView {
                mouse-drag-pan-enabled: true;
                VerticalLayout {
                    spacing: layout-spacing;
                    // Wi-Fi button(s)
                    for name[index] in wifi-network-names: i-network-button := TouchArea {
                        i-network-container := Rectangle {
                            border-radius: radius;
                            border-width: 3px;
                            border-color: item-border-color;
                            background: name == wifi-connected-name ? item-selected-color : #ffffff;

                            HorizontalLayout {
                                padding: 20px;
                                spacing: layout-spacing;

                                i-network-text := Text {
                                    color: #000000;
                                    horizontal-alignment: left;
                                    vertical-alignment: center;
                                    font-family: regular-font-family;
                                    font-size: root.default-font-size * dialog-sizes-multiplier;
                                    text: name;
                                    wrap: word-wrap;
                                }

                                Rectangle { }

                                VerticalLayout {
                                    alignment: center;
                                    HorizontalLayout {
                                        spacing: layout-spacing;
                                        if (name == wifi-connected-name): Image {
                                            source: @image-url("../../icons/wifi-connected-alt.svg");
                                            height: icon-button-height;
                                            width: self.height;
                                            colorize: i-network-button.pressed ? #ffffff : #000000;
                                        }
                                        if (wifi-network-open-vec[index]): Image {
                                            source: @image-url("../../icons/wifi-network-open.svg");
                                            height: icon-button-height;
                                            width: self.height;
                                            colorize: i-network-button.pressed ? #ffffff : #000000;
                                        }
                                        if (!wifi-network-open-vec[index]): Image {
                                            source: @image-url("../../icons/wifi-network-locked.svg");
                                            height: icon-button-height;
                                            width: self.height;
                                            colorize: i-network-button.pressed ? #ffffff : #000000;
                                        }
                                    }
                                }
                            }
                        }

                        states [
                            pressed when self.pressed: {
                                i-network-container.background: #000000;
                                i-network-text.color: #ffffff;
                            }
                        ]

                        clicked => {
                            if name == wifi-connected-name {
                                dialog-message = "IP address: \{wifi-ip-address}";
                                dialog = DialogType.Toast;
                            } else if wifi-network-open-vec[index] {
                                connect-to-wifi-network(name, "");
                            } else {
                                potential-wifi-network = name;
                                TextInputInterface.text-input-focused = true;
                                dialog = DialogType.WifiPassphrase;
                            }
                        }
                    }
                    Rectangle { }
                }
            }
            if (!wifi-enabled && !wifi-enabling-lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Enable Wi-Fi in order to connect to a network";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
            if (wifi-enabling-lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Enabling Wi-Fi";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
            if (wifi-disabling-lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Disabling Wi-Fi";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
            if (wifi-scanning-lock && !wifi-disabling-lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Scanning for networks";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
            if (wifi-connecting-lock && !wifi-disabling-lock): HorizontalLayout {
                alignment: center;
                Text {
                    text: "Connecting to network";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: root.default-font-size * 0.9;
                    wrap: word-wrap;
                    width: parent.width * 0.75;
                }
            }
        }
        if (dialog == DialogType.WifiPassphrase): VerticalLayout {
            padding: layout-padding;
            HorizontalLayout {
                IconButton {
                    icon: @image-url("../../icons/arrow-back.svg");
                    border-radius: radius;
                    height: icon-button-height;
                    width: self.height;
                    y: (parent.height - self.height) / 2;
                    clicked => {
                        TextInputInterface.text-input-focused = false;
                        dialog = DialogType.WifiUI;
                    }
                }

                Text {
                    text: "Enter passphrase";
                    font-family: header-font-family;
                    font-size: root.default-font-size * dialog-sizes-multiplier;
                    font-weight: 800;
                    wrap: word-wrap;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                Rectangle {
                    height: icon-button-height;
                    width: self.height;
                    y: (parent.height - self.height) / 2;
                }
            }

            HLine {
                top-padding-multiplier: 4.0;
                bottom-padding-multiplier: self.top-padding-multiplier;
            }

            wifi-passphrase-edit := LineEdit {
                default-height: parent.height * 0.08;
                scaling-factor: scaling-factor;
                border-radius: radius;
                placeholder-text: "Passphrase for “\{potential-wifi-network}”";
                font-size: root.default-font-size * dialog-sizes-multiplier;
                input-type: password;
            }

            Rectangle { }

            Button {
                width: 100%;
                height: button-height * dialog-sizes-multiplier;
                font-family: header-font-family;
                font-size: root.default-font-size * dialog-sizes-multiplier;
                border-radius: radius;
                text: "Connect";
                clicked => {
                    TextInputInterface.text-input-focused = false;
                    dialog = DialogType.WifiUI;
                    connect-to-wifi-network(potential-wifi-network, wifi-passphrase-edit.text);
                }
            }
        }
    }
    // Brightness dialog
    if (dialog == DialogType.Brightness): Rectangle {
        border-width: dialog-rectangle-thickness;
        border-color: black;
        border-radius: radius;
        background: white;
        width: root.width * 0.5;
        height: layout-padding + 2 * icon-button-height + layout-spacing * 2 + layout-padding;
        x: scaling-factor > 1 ? (root.width - self.width) / 2 : root.width - self.width - layout-padding;
        y: scaling-factor > 1 ? (root.height - self.height) / 2 : approx-bar-height;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        VerticalLayout {
            padding: layout-padding;
            spacing: layout-spacing * 2;
            HorizontalLayout {
                spacing: layout-spacing * 2;
                VerticalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../icons/brightness.svg");
                        width: icon-button-height;
                        height: self.width;
                    }
                }

                VerticalLayout {
                    alignment: center;
                    Slider {
                        height: slider-height;
                        value: cool-brightness;
                        changed(value) => {
                            change-cool-brightness(value);
                        }
                    }
                }
            }

            HorizontalLayout {
                spacing: layout-spacing * 2;
                VerticalLayout {
                    alignment: center;
                    Image {
                        source: @image-url("../../icons/moon.svg");
                        width: icon-button-height;
                        height: self.width;
                    }
                }

                VerticalLayout {
                    alignment: center;
                    Slider {
                        height: slider-height;
                        value: warm-brightness;
                        changed(value) => {
                            change-warm-brightness(value);
                        }
                    }
                }
            }
        }
    }
    // Battery status dialog
    if (dialog == DialogType.BatteryStatus): Rectangle {
        border-width: dialog-rectangle-thickness;
        border-color: black;
        border-radius: radius;
        background: white;
        width: scaling-factor > 1 ? root.width * 0.65 : root.width * 0.35;
        height: scaling-factor > 1 ? root.height * 0.15 : root.height * 0.1;
        x: scaling-factor > 1 ? (root.width - self.width) / 2 : root.width - self.width - layout-padding;
        y: scaling-factor > 1 ? (root.height - self.height) / 2 : approx-bar-height;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        VerticalLayout {
            padding: layout-padding;
            spacing: layout-spacing * 2;
            HorizontalLayout {
                Text {
                    text: "Status";
                    font-family: header-font-family;
                    font-size: root.default-font-size * dialog-sizes-multiplier * 0.95;
                    font-weight: 800;
                    vertical-alignment: center;
                }

                Rectangle { }

                Text {
                    text: charger-plugged-in ? "Charging" : "Discharging";
                    font-family: regular-font-family;
                    font-size: root.default-font-size * dialog-sizes-multiplier;
                    vertical-alignment: center;
                }
            }

            HorizontalLayout {
                Text {
                    text: "Charge level";
                    font-family: header-font-family;
                    font-size: root.default-font-size * dialog-sizes-multiplier * 0.95;
                    font-weight: 800;
                    vertical-alignment: center;
                }

                Rectangle { }

                Text {
                    text: "\{battery-level} %";
                    font-family: regular-font-family;
                    font-size: root.default-font-size * dialog-sizes-multiplier;
                    vertical-alignment: center;
                }
            }
        }
    }
    // Power options dialog
    if (dialog == DialogType.PowerOptions): Rectangle {
        border-width: dialog-rectangle-thickness;
        border-color: black;
        border-radius: radius;
        background: white;
        width: scaling-factor > 1 ? root.width * 0.65 : root.width * 0.35;
        height: button-height * dialog-sizes-multiplier * 2 + layout-padding * 2 + layout-spacing * 2;
        x: scaling-factor > 1 ? (root.width - self.width) / 2 : root.width - self.width - layout-padding;
        y: scaling-factor > 1 ? (root.height - self.height) / 2 : approx-bar-height;
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: true;
        }

        VerticalLayout {
            padding: layout-padding;
            spacing: layout-spacing * 2;
            Button {
                width: 100%;
                height: button-height * dialog-sizes-multiplier;
                font-family: header-font-family;
                font-size: root.default-font-size * dialog-sizes-multiplier;
                border-radius: radius;
                text: "Power off";
                clicked => {
                    TextInputInterface.text-input-focused = false;
                    dialog = DialogType.None;
                    if page == Page.UserLogin {
                        shutdown-command = RootFsShutDownCommand.PowerOff;
                        prepare-splash-wallpaper();
                        if startup-finished {
                            direct-power-off();
                        }
                    } else {
                        prepare-splash-wallpaper();
                        power-off();
                    }
                }
            }

            Button {
                width: 100%;
                height: button-height * dialog-sizes-multiplier;
                font-family: header-font-family;
                font-size: root.default-font-size * dialog-sizes-multiplier;
                border-radius: radius;
                text: "Reboot";
                clicked => {
                    TextInputInterface.text-input-focused = false;
                    dialog = DialogType.None;
                    if page == Page.UserLogin {
                        page = Page.ShutDownSplash;
                        shutdown-command = RootFsShutDownCommand.Reboot;
                        prepare-splash-wallpaper();
                        if startup-finished {
                            direct-reboot();
                        }
                    } else {
                        standard-reboot();
                    }
                }
            }
        }
    }

    // Virtual keyboard
    ScrollView {
        VerticalLayout {
            alignment: end;
            visible: TextInputInterface.text-input-focused;
            changed visible => {
                if (self.visible == false) {
                    VirtualKeyboardHandler.current-key-set = 0;
                    i-keyboard.shift = false;
                }
            }
            i-keyboard := VirtualKeyboard {
                font-family: header-font-family;
                radius: radius;
                key-height: keyboard-key-height;
                scaling-factor: scaling-factor;
                close => {
                    TextInputInterface.text-input-focused = false;
                    if (dialog == DialogType.WifiPassphrase) {
                        dialog = DialogType.WifiUI;
                    } else {
                        dialog = DialogType.None;
                    }
                }
            }
        }
    }

    TouchArea {
        width: parent.width;
        height: parent.height;
        enabled: !enable-ui;
    }
}
